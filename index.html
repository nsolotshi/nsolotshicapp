<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSOLOTSHICAPP - CALCUL DECOMPTE FINAL</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NSOLOTSHICAPP">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2563eb/FFFFFF?text=NS">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            position: relative;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .app-header h2 {
            font-size: 18px;
            font-weight: 400;
            opacity: 0.9;
        }

        .progress-container {
            padding: 20px 30px 0;
            background: white;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: var(--shadow-sm);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .page {
            display: none;
            padding: 30px;
            background: white;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 12px;
            font-size: 22px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--gray-100);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        .section-subtitle {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 15px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 15px;
            transition: var(--transition);
            background: white;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
        }

        .form-hint {
            display: block;
            margin-top: 6px;
            font-size: 13px;
            color: var(--gray-500);
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            margin-right: 0;
            font-weight: normal;
            cursor: pointer;
            padding: 10px 15px;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .radio-group label:hover, .checkbox-group label:hover {
            border-color: var(--primary);
            background: #f5f9ff;
        }

        .radio-group input, .checkbox-group input {
            width: auto;
            margin-right: 8px;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1e40af 100%);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #0d966c 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #0d966c 0%, #0a7555 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .hidden {
            display: none;
        }

        .conditional-section {
            padding: 20px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--radius);
            margin-top: 20px;
            border-left: 4px solid var(--primary-light);
        }

        .intro-text {
            margin-bottom: 25px;
            line-height: 1.7;
        }

        .intro-text p {
            margin-bottom: 15px;
        }

        .promo-banner {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 18px;
            border-radius: var(--radius);
            text-align: center;
            margin: 25px 0;
            color: #c2410c;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid #ea580c;
        }

        .contact-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--radius);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .contact-link.email {
            background: var(--primary);
            color: white;
        }

        .contact-link.email:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .contact-link.whatsapp {
            background: #25D366;
            color: white;
        }

        .contact-link.whatsapp:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        /* Styles pour la page de résultats */
        .result-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .result-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-content {
            padding: 25px;
            background: var(--gray-100);
            min-height: 200px;
            border-radius: 0 0 var(--radius) var(--radius);
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            font-size: 14px;
        }

        .print-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .print-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .result-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding: 20px;
            background: var(--gray-100);
            border-radius: var(--radius);
        }

        /* États de chargement et erreur */
        .loading-state, .error-state, .success-result {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-icon, .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .error-icon {
            color: var(--danger);
        }

        .success-icon {
            color: var(--success);
        }

        .error-message {
            background: #fee2e2;
            padding: 16px;
            border-radius: var(--radius);
            color: var(--danger);
            margin: 20px 0;
            border-left: 4px solid var(--danger);
        }

        .error-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .review-item {
            margin-bottom: 20px;
            padding: 18px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-light);
            transition: var(--transition);
        }

        .review-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .review-question {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .review-answer {
            color: var(--gray-600);
            margin-left: 10px;
            margin-bottom: 15px;
            padding-left: 15px;
            border-left: 2px solid var(--gray-300);
        }

        .edit-btn {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 8px 16px;
            font-size: 14px;
            border-radius: var(--radius);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .edit-btn:hover {
            background: var(--gray-300);
        }

        .payment-info {
            background: var(--gray-100);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--accent);
        }

        .payment-status {
            padding: 18px;
            border-radius: var(--radius);
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }

        .payment-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .payment-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .payment-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .confirmation-message, .error-message {
            text-align: center;
            padding: 40px 20px;
        }

        .confirmation-text, .error-text {
            background: white;
            padding: 25px;
            border-radius: var(--radius);
            margin: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .confirmation-text p, .error-text p {
            margin: 0;
            font-size: 16px;
            line-height: 1.6;
            color: var(--gray-700);
        }

        /* Installation PWA */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .install-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .install-instructions {
            background: var(--gray-100);
            padding: 20px;
            border-radius: var(--radius);
            margin: 25px 0;
            border-left: 4px solid var(--accent);
        }

        .install-instructions h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .install-instructions ul {
            padding-left: 20px;
            margin: 15px 0;
        }

        .install-instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .app-header h1 {
                font-size: 22px;
            }
            
            .app-header h2 {
                font-size: 16px;
            }
            
            .page {
                padding: 20px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .btn-container {
                flex-direction: column;
                gap: 15px;
            }
            
            button {
                width: 100%;
            }
            
            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .contact-links {
                flex-direction: column;
            }
            
            .error-actions {
                flex-direction: column;
            }
            
            .result-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .install-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        /* Animation pour les transitions de page */
        .page-transition {
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Amélioration des selects */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 45px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>NSOLOTSHICAPP</h1>
            <h2>CALCUL DE DÉCOMPTE FINAL / DOMMAGES ET INTÉRÊTS / PENSION</h2>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="progress-text">
                <span id="currentStep">Étape 1 sur 16</span>
                <span id="progressPercentage">0%</span>
            </div>
        </div>
        
        <!-- Page 1: Introduction -->
        <div class="page active" id="page1">
            <h2 class="page-title"><i class="fas fa-info-circle"></i> Introduction</h2>
            
            <div class="intro-text">
                <p><strong>Une application de calcul de décompte final pour le contrat de travail à durée indéterminée régi par le Droit de la République démocratique du Congo.</strong></p>
                
                <p>Cette application est à l'usage de tous : Employeur, Travailleur, Inspecteur du travail, Avocat, Magistrats (juges).</p>
                
                <p>Remplissez correctement et avec des données vraies, le formulaire ci-dessous; et à la fin vous obtiendrez instantanément les résultats du décompte final, pension et dommages-intérêts.</p>
            </div>
            
            <div class="promo-banner">
                <i class="fas fa-gift"></i> Bénéficier de notre prix promotionnel: 10.000FC au lieu de 60.000FC par soumission.
            </div>
            
            <!-- Ajouter ce bouton dans votre interface -->
            <button id="installButton" class="install-btn" style="display: none;">
                <i class="fas fa-download"></i> Installer l'application
            </button>
            
            <div class="contact-links">
                <a href="mailto:nsolotshi3@gmail.com?subject=Demande%20d'informations&body=Bonjour,%0AJe%20souhaite%20avoir%20des%20renseignements." class="contact-link email">
                    <i class="fas fa-envelope"></i> Envoyer un mail
                </a>
                <a href="https://wa.me/243998653400?text=Bonjour%2C%20je%20vous%20contacte%20depuis%20votre%20site" target="_blank" class="contact-link whatsapp">
                    <i class="fab fa-whatsapp"></i> Message WhatsApp
                </a>
            </div>
            
            <div class="btn-container">
                <button class="btn-primary" id="startBtn">
                    <i class="fas fa-play"></i> Commencer
                </button>
            </div>
        </div>
        
        <!-- Page 2: Employer Identification -->
        <div class="page" id="page2">
            <h2 class="page-title"><i class="fas fa-building"></i> Identification de l'employeur</h2>
            
            <div class="form-group">
                <label for="employerName">1. Nom ou dénomination de l'employeur :</label>
                <input type="text" id="employerName" required>
            </div>
            
            <div class="form-group">
                <label for="employerLocation">2. Lieu du siège de l'entreprise :</label>
                <input type="text" id="employerLocation" required>
            </div>
            
            <div class="btn-container">
                <button class="btn-secondary" id="backToPage1">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button class="btn-primary" id="nextToPage3">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Page 3: Worker Identification -->
        <div class="page" id="page3">
            <h2 class="page-title"><i class="fas fa-user"></i> Identification du Travailleur</h2>
            
            <div class="form-group">
                <label for="workerName">3. Nom du travailleur pour lequel on calcul le décompte final :</label>
                <input type="text" id="workerName" required>
            </div>
            
            <div class="form-group">
                <label for="birthDate">4. Date de naissance :</label>
                <input type="date" id="birthDate" max="" required>
            </div>
            
            <div class="form-group">
                <label>5. Sexe :</label>
                <div class="radio-group">
                    <label><input type="radio" name="gender" value="Homme" checked> Homme</label>
                    <label><input type="radio" name="gender" value="Femme"> Femme</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="maritalStatus">6. Etat civil à rupture du contrat :</label>
                <select id="maritalStatus" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="célibataire">Célibataire</option>
                    <option value="marié(e)">Marié(e)</option>
                    <option value="veuf (veuve)">Veuf (veuve)</option>
                    <option value="divorcé(e)">Divorcé(e)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="childrenCount">7. Nombre d'enfant à charge, connus de l'employeur avant la rupture du contrat :</label>
                <input type="number" id="childrenCount" min="0" required>
            </div>
            
            <div class="btn-container">
                <button class="btn-secondary" id="backToPage2">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button class="btn-primary" id="nextToPage4">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Page 4: Contract Information -->
        <div class="page" id="page4">
            <h2 class="page-title"><i class="fas fa-file-contract"></i> Renseignements sur la conclusion et la rupture du contrat</h2>
            
            <div class="form-group">
                <label>8. Le contrat de travail était-il par écrit ou verbal :</label>
                <div class="radio-group">
                    <label><input type="radio" name="contractType" value="écrit" checked> Écrit</label>
                    <label><input type="radio" name="contractType" value="verbal"> Verbal</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>9. Le contrat de travail était-il expressément ou implicitement à durée indéterminée :</label>
                <div class="radio-group">
                    <label><input type="radio" name="indefiniteContract" value="OUI" checked required> OUI</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="contractStartDate">10. Date de conclusion du contrat de travail :</label>
                <input type="date" id="contractStartDate" max="" required>
            </div>
            
            <div class="form-group">
                <label for="recruitmentLocation">11. Ville ou village de recrutement du travailleur :</label>
                <input type="text" id="recruitmentLocation" required>
            </div>
            
            <div class="form-group">
                <label for="workDaysPerWeek">12. Nombre de jours de travail par semaine :</label>
                <input type="number" id="workDaysPerWeek" min="1" max="7" required
                    oninput="validateWorkDays(this)">
                <small class="form-hint">Doit être entre 1 et 7 jours</small>
            </div>
            
            <div class="form-group">
                <label for="contractEndDate">13. Date de rupture ou de fin du contrat :</label>
                <input type="date" id="contractEndDate" max="" required>
            </div>
            
            <div class="form-group">
                <label for="terminationLocation">14. Ville ou village dans laquelle rupture du contrat a eu lieu :</label>
                <input type="text" id="terminationLocation" required>
            </div>
            
            <div class="form-group">
                <label for="lastAssignment">15. Dernier lieu d'affectation du travailleur :</label>
                <input type="text" id="lastAssignment" required>
            </div>
            
            <div class="form-group">
                <label>16. Ce dernier lieu d'affectation du travailleur est-il le même que le lieu de recrutement ? :</label>
                <div class="radio-group">
                    <label><input type="radio" name="sameLocation" value="OUI" checked> OUI</label>
                    <label><input type="radio" name="sameLocation" value="NON"> NON</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="terminationParty">17. Modalité de rupture du contrat de travail :</label>
                <select id="terminationParty" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="Décision du travailleur">Décision du Travailleur</option>
                    <option value="Décision de l'employeur">Décision de l'employeur</option>
                    <option value="Commun accord entre travailleur et employeur">Commun accord entre travailleur et employeur</option>
                    <option value="La mort du travailleur">La mort du travailleur</option>
                    <option value="force majeure anéantissant l'emploi ou l'entreprise">force majeure anéantissant l'emploi ou l'entreprise</option>
                </select>
            </div>
            
            <!-- Conditional questions based on termination party -->
            <div id="employerTerminationSection" class="hidden conditional-section">
                <h3 class="section-subtitle">Détails sur la rupture par l'employeur</h3>
                
                <div class="form-group">
                    <label>18. La décision de l'employeur était-elle écrite ? :</label>
                    <div class="radio-group">
                        <label><input type="radio" name="writtenDecision" value="OUI"> OUI</label>
                        <label><input type="radio" name="writtenDecision" value="NON"> NON</label>
                    </div>
                </div>
                
                <div id="writtenDecisionYesSection" class="hidden conditional-section">
                    <div class="form-group">
                        <label for="noticePeriodDays">19. Combien de jour de préavis, l'employeur a-t-il donné dans sa lettre de licenciement au travailleur :</label>
                        <input type="number" id="noticePeriodDays" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="terminationReason">20. Quel est le motif que l'employeur évoque dans la lettre de licenciement :</label>
                        <select id="terminationReason">
                            <option value="">-- Sélectionnez --</option>
                            <option value="inaptitude du travailleur">Inaptitude du travailleur</option>
                            <option value="faute simple du travailleur">Faute simple du travailleur</option>
                            <option value="faute lourde du travailleur">Faute lourde du travailleur</option>
                            <option value="raison économique ou nécessité de fonctionnement">Raison économique ou nécessité de fonctionnement</option>
                        </select>
                    </div>
                    
                    <div id="economicReasonSection" class="hidden conditional-section">
                        <div class="form-group">
                            <label>21. L'employeur a-t-il obtenu l'autorisation de l'Inspecteur du travail ou du Ministre chargé du travail pour y procéder ?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="workInspectorAuthorization" value="OUI"> OUI</label>
                                <label><input type="radio" name="workInspectorAuthorization" value="NON"> NON</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="seriousFaultSection" class="hidden conditional-section">
                        <div class="form-group">
                            <label for="faultKnowledgeDate">22. À quelle date l'employeur a eu connaissance des faits fautifs qu'il reproche au travailleur ?</label>
                            <input type="date" id="faultKnowledgeDate" max="">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="terminationMotivationEvaluation">23. Comment trouvez vous les motifs de licenciement avancé par l'employeur dans sa lettre de licenciement :</label>
                        <select id="terminationMotivationEvaluation">
                            <option value="">-- Sélectionnez --</option>
                            <option value="raisons justifiées mais sans preuve">Raisons justifiées mais sans preuve</option>
                            <option value="raisons non légalement justifiées">Raisons non légalement justifiées</option>
                            <option value="raisons justifiées et avec preuves à l'appui">Raisons justifiées et avec preuves à l'appui</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="workerTerminationSection" class="hidden conditional-section">
                <h3 class="section-subtitle">Détails sur la rupture par le travailleur</h3>
                
                <div class="form-group">
                    <label for="resignationReason">24. Pour quel motif le travailleur a-t-il démissionné :</label>
                    <select id="resignationReason">
                        <option value="">-- Sélectionnez --</option>
                        <option value="le travailleur n'a pas révélé son motif">Le travailleur n'a pas révélé son motif</option>
                        <option value="le travailleur déclare avoir démissionné à cause de faute de l'employeur">Le travailleur déclare avoir démissionné à cause de faute de l'employeur</option>
                        <option value="le travailleur évoque un motif personnel">Le travailleur évoque un motif personnel</option>
                    </select>
                </div>
                
                <div id="employerFaultSection" class="hidden conditional-section">
                    <div class="form-group">
                        <label for="workerComplaintsEvaluation">25. Comment trouvez vous les motifs ou reproches avancés par le travailleur contre l'employeur :</label>
                        <select id="workerComplaintsEvaluation">
                            <option value="">-- Sélectionnez --</option>
                            <option value="reproches justifiés mais sans preuve">Reproches justifiés mais sans preuve</option>
                            <option value="reproches non légalement justifiés">Reproches non légalement justifiés</option>
                            <option value="reproches justifiées avec preuve à l'appui">Reproches justifiées avec preuve à l'appui</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn-secondary" id="backToPage3">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button class="btn-primary" id="nextToPage5">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Page 5: Worker Category and Work Hours -->
        <div class="page" id="page5">
            <h2 class="page-title"><i class="fas fa-briefcase"></i> Catégorie de travailleur et régime des heures de prestation de service</h2>
            
            <div class="form-group">
                <label for="workerCategory">26. Choisissez la catégorie et échelon du travailleur au moment de la rupture du contrat :</label>
                <select id="workerCategory" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="je ne sais pas sa catégorie">Je ne sais pas sa catégorie</option>
                    <option value="Manœuvre Ordinaire">Manœuvre Ordinaire</option>
                    <option value="Manœuvre Lourd">Manœuvre Lourd</option>
                    <option value="Travailleur spécialisé">Travailleur spécialisé</option>
                    <option value="Travailleur semi qualifié échelon 1">Travailleur semi qualifié échelon 1</option>
                    <option value="Travailleur semi qualifié échelon 2">Travailleur semi qualifié échelon 2</option>
                    <option value="Travailleur semi qualifié échelon 3">Travailleur semi qualifié échelon 3</option>
                    <option value="Travailleur qualifié échelon 1">Travailleur qualifié échelon 1</option>
                    <option value="Travailleur qualifié échelon 2">Travailleur qualifié échelon 2</option>
                    <option value="Travailleur Hautement qualifié">Travailleur Hautement qualifié</option>
                    <option value="Maîtrise échelon 1">Maîtrise échelon 1</option>
                    <option value="Maîtrise échelon 2">Maîtrise échelon 2</option>
                    <option value="Maîtrise échelon 3">Maîtrise échelon 3</option>
                    <option value="Maîtrise échelon 4">Maîtrise échelon 4</option>
                    <option value="Cadre de collaboration échelon 1">Cadre de collaboration échelon 1</option>
                    <option value="Cadre de collaboration échelon 2">Cadre de collaboration échelon 2</option>
                    <option value="Cadre de collaboration échelon 3">Cadre de collaboration échelon 3</option>
                    <option value="Cadre de collaboration échelon 4">Cadre de collaboration échelon 4</option>
                </select>
            </div>

            <div id="monthsInCategorySection" class="hidden conditional-section">
                <div class="form-group">
                    <label for="monthsInCategory">26bis. Combien de mois le travailleur a fait dans cette catégorie :</label>
                    <input type="number" id="monthsInCategory" min="0">
                </div>
            </div>
            
            <div id="unknownCategorySection" class="hidden conditional-section">
                <div class="form-group">
                    <label for="categoryHelp">27. Choisissez la caractéristique qui correspond à l'emploi occupé par le travailleur</label>
                    <select id="categoryHelp">
                        <option value="">-- Sélectionnez --</option>
                        <option value="emploi léger que tout le monde peut faire et qui ne requiert pas un quelconque niveau d'étude">1) emploi léger que tout le monde peut faire et qui ne requiert pas un quelconque niveau d'étude</option>
                        <option value="emploi à la portée de tous et qui ne requiert pas un quelconque niveau d'étude mais dangereux pour la santé">2) emploi à la portée de tous et qui ne requiert pas un quelconque niveau d'étude mais dangereux pour la santé</option>
                        <option value="emploi qui ne requiert pas un niveau d'étude mais dont ne peut pas faire que les personnes initiées">3) emploi qui ne requiert pas un niveau d'étude mais dont ne peut pas faire que les personnes initiées</option>
                        <option value="emploi qui nécessite de savoir lire et écrire avec un niveau d'école primaire">4) emploi qui nécessite de savoir lire et écrire avec un niveau d'école primaire</option>
                        <option value="emploi qui nécessite savoir lire et écrire avec un niveau d'étude secondaire (diplôme d'Etat)">5) emploi qui nécessite savoir lire et écrire avec un niveau d'étude secondary (diplôme d'Etat)</option>
                        <option value="emploi qui nécessite un niveau universitaire ou une expérience technique avérée">6) emploi qui nécessite un niveau universitaire ou une expérience technique avérée</option>
                        <option value="emploi conférant une responsabilité de gestion d'un département ou d'un établissement de l'entreprise">7) emploi conférant une responsabilité de gestion d'un département ou d'un établissement de l'entreprise</option>
                        <option value="emploi conférant la responsabilité de diriger toute l'entreprise en prenant des décisions autonomes pouvant affecter la marche de l'entreprise">8) emploi conférant la responsabilité de diriger toute l'entreprise en prenant des décisions autonomes pouvant affecter la marche de l'entreprise</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="workRegime">28. Choisissez le régime juridique des heures de travail par jour et semaine pour ce travailleur :</label>
                <select id="workRegime" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="travail de sentinelle ou veilleur de nuit dont la durée légale est de 12h par jour et 72 heures par semaine">1) Travail de sentinelle ou veilleur de nuit dont la durée légale est de 72 heures par semaine</option>
                    <option value="travail de gardiennage ou de surveillance dont la durée légale de travail est de 10h par jour and 60h par semaine">2) Travail de gardiennage ou de surveillance dont la durée légale de travail est de 60h par semaine</option>
                    <option value="travail de domestique dont la durée légale est de 9h par jour and 54 heures par semaine">3) Travail de domestique dont la durée légale est de 54 heures par semaine</option>
                <option value="travail normal dont la durée légale est de 8h par jour and 48h par semaine">4) Travail normal dont la durée légale est de 48h par semaine</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="dailyWorkHours">29. Combien d'heure de service le travailleur effectuait-il habituellement par jour de service :</label>
            <input type="number" id="dailyWorkHours" min="1" max="24" required
                    title="Doit être entre 1 et 24 heures">
            <small class="form-hint">(Valeur comprise entre 1 et 24 heures)</small>
        </div>
        
        <div class="form-group">
            <label>30. Le travailleur a-t-il réalisé des heures supplémentaires non payées au cours de 12 derniers mois ayant précédé la rupture du contrat :</label>
            <div class="radio-group">
                <label><input type="radio" name="unpaidOvertime" value="OUI"> OUI</label>
                <label><input type="radio" name="unpaidOvertime" value="NON" checked> NON</label>
            </div>
        </div>
        
        <div id="overtimeSection" class="hidden conditional-section">
            <h3 class="section-subtitle">Détails sur les heures supplémentaires</h3>
            
            <div class="form-group">
                <label for="totalOvertimeHours">31. Combien d'heures supplémentaires au total le travailleur a réalisé au cours de 12 derniers mois du contrat :</label>
                <input type="number" id="totalOvertimeHours" min="0">
            </div>
            
            <div class="form-group">
                <label>32. Dans ce total d'heure supplémentaires, faite la répartition selon les critères ci-dessous :</label>
                <div class="form-group">
                    <label for="sundayOvertime">a) Nombre heures supplémentaires de jours de repos (dimanche) :</label>
                    <input type="number" id="sundayOvertime" min="0">
                </div>
                
                <div class="form-group">
                    <label for="holidayOvertime">b) Nombre heures supplémentaires de jours fériés légaux ou jours non ouvrables :</label>
                    <input type="number" id="holidayOvertime" min="0">
                </div>
                
                <div class="form-group">
                    <label for="firstWeeklyOvertime">c) Nombre d'heures supplémentaires de dans la tranche de 6 premières heures hebdomadaires :</label>
                    <input type="number" id="firstWeeklyOvertime" min="0">
                </div>
                
                <div class="form-group">
                    <label for="remainingOvertime">d) Nombre de reste d'heures supplémentaires :</label>
                    <input type="number" id="remainingOvertime" min="0">
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn-secondary" id="backToPage4">
                <i class="fas fa-arrow-left"></i> Précédent
            </button>
            <button class="btn-primary" id="nextToPage6">
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Page 6: Salary and Benefits -->
    <div class="page" id="page6">
        <h2 class="page-title"><i class="fas fa-money-bill-wave"></i> Rémunération et avantages convenus et leurs arriérés</h2>
        
        <div class="form-section">
            <h3 class="section-subtitle">Rémunération et avantages convenus</h3>
            
            <div class="form-group">
                <label for="salaryCurrency">a) Monnaie de paiement :</label>
                <select id="salaryCurrency" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="monthlySalary">b) Montant de salaire et prime par mois :</label>
                <input type="number" id="monthlySalary" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="monthlyTransport">c) Montant de transport par mois :</label>
                <input type="number" id="monthlyTransport" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="monthlyHousing">d) Montant de logement par mois :</label>
                <input type="number" id="monthlyHousing" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="monthlyFamilyAllowance">e) Montant des allocation familiale par mois :</label>
                <input type="number" id="monthlyFamilyAllowance" min="0" step="0.01" required>
            </div>
        </div>
        
        <div class="form-section">
            <h3 class="section-subtitle">Arriérés de rémunération</h3>
            
            <div class="form-group">
                <label for="unpaidAmount">a) Montant total :</label>
                <input type="number" id="unpaidAmount" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="unpaidCurrency">b) Monnaie de ce dernier montant :</label>
                <select id="unpaidCurrency" required>
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn-secondary" id="backToPage5">
                <i class="fas fa-arrow-left"></i> Précédent
            </button>
            <button class="btn-primary" id="nextToPage7">
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Page 7: Mandatory Benefits Verification -->
    <div class="page" id="page7">
        <h2 class="page-title"><i class="fas fa-shield-alt"></i> Vérification de paiement des avantages obligatoires</h2>
        
        <div class="form-group">
            <label for="commuteDistance">35. Quelle est la distance moyenne en kilomètre, du trajet qu'effectuait le travailleur de son domicile au lieu de service :</label>
            <select id="commuteDistance" required>
                <option value="">-- Sélectionnez --</option>
                <option value="moins d'un km">Moins d'un km</option>
                <option value="de 1 à 3 km">De 1 à 3 km</option>
                <option value="plus de 3 km">Plus de 3 km</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>36. L'employeur avait-il pourvu en argent ou en espèce, au transport du travailleur de son domicile au lieu du travail et vice versa ? :</label>
            <select id="transportProvision" required>
                <option value="">-- Sélectionnez --</option>
                <option value="pas du tout">Pas du tout</option>
                <option value="partiellement">Partiellement</option>
                <option value="oui totalement">Oui totalement</option>
            </select>
        </div>
        
        <div id="transportCostSection" class="hidden conditional-section">
            <h3 class="section-subtitle">Coûts de transport supportés par le travailleur</h3>
            
            <div class="form-group">
                <label for="dailyTransportCurrency">a) Monnaie :</label>
                <select id="dailyTransportCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="dailyTransportCost">b) Montant de transport par jour supporté par le travailleur :</label>
                <input type="number" id="dailyTransportCost" min="0" step="0.01">
            </div>
        </div>
        
        <div class="form-group">
            <label>38. L'employeur ou un tiers assureur payé par lui, avait-il pourvu en nature ou en espèce au logement du travailleur ?</label>
            <div class="radio-group">
                <label><input type="radio" name="housingProvided" value="OUI"> OUI</label>
                <label><input type="radio" name="housingProvided" value="NON" checked> NON</label>
            </div>
        </div>
        
        <div id="housingCostSection" class="hidden conditional-section">
            <h3 class="section-subtitle">Coûts de logement supportés par le travailleur</h3>
            
            <div class="form-group">
                <label for="housingCurrency">a) Monnaie :</label>
                <select id="housingCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="monthlyHousingCost">b) Montant de logement supporté par le travailleur lui-même par mois :</label>
                <input type="number" id="monthlyHousingCost" min="0" step="0.01">
            </div>
        </div>
        
        <div class="form-group">
            <label>40. Est-ce qu'un tiers assureur contractant avec l'employeur, versait des allocations familiale au travailleur?</label>
            <div class="radio-group">
                <label><input type="radio" name="familyAllowancePaid" value="OUI"> OUI</label>
                <label><input type="radio" name="familyAllowancePaid" value="NON" checked> NON</label>
            </div>
        </div>
        
        <div id="familyAllowanceSection" class="hidden conditional-section">
            <h3 class="section-subtitle">Allocations familiales versées</h3>
            
            <div class="form-group">
                <label for="familyAllowanceCurrency">a) Monnaie :</label>
                <select id="familyAllowanceCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="actualFamilyAllowance">b) Montant des allocations familiales payées au travailleur par mois :</label>
                <input type="number" id="actualFamilyAllowance" min="0" step="0.01">
            </div>
        </div>
        
        <div class="form-group">
    <label>42. L'employeur ou un tiers assureur payé par lui, pourvoyait-il, en nature ou en espèce, aux soins de santé du travailleur, son conjoint et ses enfants à charge :</label>
    <div class="radio-group">
        <label><input type="radio" name="healthcareProvided" value="OUI"> OUI</label>
        <label><input type="radio" name="healthcareProvided" value="NON" checked> NON</label>
    </div>
</div>

<div class="form-group">
    <label>43. Y a-t-il dans les 3 dernières années, des factures de soins de santé du travailleur, de son conjoint ou de son enfant à charge, que l'employeur n'a not payé au cours de 3 dernières années dernières précédant la rupture du contrat :</label>
    <div class="radio-group">
        <label><input type="radio" name="unpaidMedicalBills" value="OUI"> OUI</label>
        <label><input type="radio" name="unpaidMedicalBills" value="NON" checked> NON</label>
    </div>
</div>

<div id="medicalBillsSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Factures médicales impayées</h3>
    
    <div class="form-group">
        <label for="medicalBillsCurrency">a) Monnaie :</label>
        <select id="medicalBillsCurrency">
            <option value="">-- Sélectionnez --</option>
            <option value="francs congolais">francs congolais</option>
            <option value="dollars américains">dollars américains</option>
            <option value="euro">Euro</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="medicalBillsAmount">b) Montant total des factures de soins supporté non payé par l'employeur :</label>
        <input type="number" id="medicalBillsAmount" min="0" step="0.01">
    </div>
</div>

<div class="form-group">
    <label>45. Le travailleurs a-t-il effectué des voyages de services à ses frais que l'employeur n'a not remboursé ces 2 dernières années ? :</label>
    <div class="radio-group">
        <label><input type="radio" name="businessTrips" value="OUI"> OUI</label>
        <label><input type="radio" name="businessTrips" value="NON" checked> NON</label>
    </div>
</div>

<div id="businessTripsSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Frais de voyages de service non remboursés</h3>
    
    <div class="form-group">
        <label for="businessTripsCurrency">a) Monnaie :</label>
        <select id="businessTripsCurrency">
            <option value="">-- Sélectionnez --</option>
            <option value="francs congolais">francs congolais</option>
            <option value="dollars américains">dollars américains</option>
            <option value="euro">Euro</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="businessTripsAmount">b) Montant de des frais de voyages de services supportés par le travailleur lui-même :</label>
        <input type="number" id="businessTripsAmount" min="0" step="0.01">
    </div>
</div>

<div class="btn-container">
    <button class="btn-secondary" id="backToPage6">
        <i class="fas fa-arrow-left"></i> Précédent
    </button>
    <button class="btn-primary" id="nextToPage8">
        Suivant <i class="fas fa-arrow-right"></i>
    </button>
</div>
</div>

<!-- Page 8: Annual Leave -->
<div class="page" id="page8">
<h2 class="page-title"><i class="fas fa-umbrella-beach"></i> Congé annuel et ses avantages</h2>

<div class="form-group">
    <label for="annualLeaveTaken">47. Combien de congé annuel le travailleur a-t-il pris au cours de 2 de dernières années du contrat :</label>
    <input type="number" id="annualLeaveTaken" min="0" max="2" required>
    <small class="form-hint">Valeur entre 0 et 2</small>
</div>

<div class="form-group">
    <label>48. Est-ce que le contrat (ou l'entreprise) prévoit un nombre de jours de congé annuel que le travailleur doit bénéficier après chaque année entière de service :</label>
    <div class="radio-group">
        <label><input type="radio" name="annualLeaveDefined" value="OUI"> OUI</label>
        <label><input type="radio" name="annualLeaveDefined" value="NON" checked> NON</label>
    </div>
</div>

<div id="annualLeaveDaysSection" class="hidden conditional-section">
    <div class="form-group">
        <label for="definedAnnualLeaveDays">49. Préciser ce nombre de jours de congé annuel prévu par le contrat ou l'entreprise :</label>
        <input type="number" id="definedAnnualLeaveDays" min="0">
    </div>
</div>

<div class="form-group">
    <label>50. En dehors de sa rémunération pour le jour de congé, est-ce que le contrat ou l'entreprise prévoit un autre avantage (tel que billet de voyage, hôtel ou frais de séjour) pour le travailleur a prend le congé annuel :</label>
    <div class="radio-group">
        <label><input type="radio" name="leaveBenefits" value="OUI"> OUI</label>
        <label><input type="radio" name="leaveBenefits" value="NON" checked> NON</label>
    </div>
</div>

<div id="leaveBenefitsSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Avantages liés au congé annuel</h3>
    
    <div class="form-group">
        <label for="leaveBenefitAmount">a) Montant des avantages d'un congé en argent :</label>
        <input type="number" id="leaveBenefitAmount" min="0" step="0.01">
    </div>
    
    <div class="form-group">
        <label for="leaveBenefitCurrency">b) Monnaie :</label>
        <select id="leaveBenefitCurrency">
            <option value="">-- Sélectionnez --</option>
            <option value="francs congolais">francs congolais</option>
            <option value="dollars américains">dollars américains</option>
            <option value="euro">Euro</option>
        </select>
    </div>
    
    <div id="oneLeaveBenefitSection" class="hidden conditional-section">
        <div class="form-group">
            <label for="oneLeaveBenefitReceived">52. Combien le travailleur a-t-il reçu comme avantage pour le seul congé qu'il a bénéficié :</label>
            <input type="number" id="oneLeaveBenefitReceived" min="0" step="0.01">
        </div>
    </div>
    
    <div id="twoLeaveBenefitsSection" class="hidden conditional-section">
        <div class="form-group">
            <label for="twoLeaveBenefitsReceived">53. Combien le travailleur a-t-il reçu au total comme avantage pour les 2 congés annuels qu'il a bénéficié :</label>
            <input type="number" id="twoLeaveBenefitsReceived" min="0" step="0.01">
        </div>
    </div>
</div>

<div class="btn-container">
    <button class="btn-secondary" id="backToPage7">
        <i class="fas fa-arrow-left"></i> Précédent
    </button>
    <button class="btn-primary" id="nextToPage9">
        Suivant <i class="fas fa-arrow-right"></i>
    </button>
</div>
</div>

<!-- Page 9: Notice Period -->
<div class="page" id="page9">
<h2 class="page-title"><i class="fas fa-calendar-alt"></i> Le préavis</h2>

<div class="form-group">
    <label>54. Le travailleur a-t-il presté un préavis pendant un certain nombre de jours :</label>
    <div class="radio-group">
        <label><input type="radio" name="noticePeriodServed" value="OUI"> OUI</label>
        <label><input type="radio" name="noticePeriodServed" value="NON" checked> NON</label>
    </div>
</div>

<div id="noticePeriodServedSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Préavis effectivement presté</h3>
    
    <div class="form-group">
        <label for="noticePeriodDaysPage9">55. Combien de jours de préavis le travailleurs a-t-il prestés :</label>
        <input type="number" id="noticePeriodDaysPage9" min="0">
    </div>
    
    <div class="form-group">
        <label>56. Combien d'argent le travailleur a touché comme rémunération et avantage pour ces jours de préavis :</label>
        
        <div class="form-group">
            <label for="noticePaymentCurrency">a) Monnaie :</label>
            <select id="noticePaymentCurrency">
                <option value="">-- Sélectionnez --</option>
                <option value="francs congolais">francs congolais</option>
                <option value="dollars américains">dollars américains</option>
                <option value="euro">Euro</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="noticePaymentAmount">b) Montant (tout compris) :</label>
            <input type="number" id="noticePaymentAmount" min="0" step="0.01">
        </div>
    </div>
</div>

<div id="noticePeriodNotServedSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Indemnité de préavis</h3>
    
    <div class="form-group">
        <label>57. Le travailleur a-t-il touché une indemnité de préavis (un montant pour compenser le préavis qu'il n'a pas effectivement presté) ? :</label>
        <div class="radio-group">
            <label><input type="radio" name="noticeCompensation" value="OUI"> OUI</label>
            <label><input type="radio" name="noticeCompensation" value="NON" checked> NON</label>
        </div>
    </div>
    
    <div id="noticeCompensationSection" class="hidden conditional-section">
        <div class="form-group">
            <label>58. Combien d'argent le travailleur a touché comme indemnité de préavis :</label>
            
            <div class="form-group">
                <label for="compensationCurrency">a) Monnaie :</label>
                <select id="compensationCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="compensationAmount">b) Montant :</label>
                <input type="number" id="compensationAmount" min="0" step="0.01">
            </div>
        </div>
    </div>
</div>

<div class="btn-container">
    <button class="btn-secondary" id="backToPage8">
        <i class="fas fa-arrow-left"></i> Précédent
    </button>
    <button class="btn-primary" id="nextToPage10">
        Suivant <i class="fas fa-arrow-right"></i>
    </button>
</div>
</div>

<!-- Page 10: Return Trip (Conditional) -->
<div class="page" id="page10">
<h2 class="page-title"><i class="fas fa-plane"></i> Voyage retour</h2>

<div class="form-group">
    <label>59. Le travailleur a-t-il demandé le voyage retour vers le lieu où il a été recruté? :</label>
    <div class="radio-group">
        <label><input type="radio" name="returnTripRequested" value="OUI"> OUI</label>
        <label><input type="radio" name="returnTripRequested" value="NON" checked> NON</label>
    </div>
</div>

<div id="returnTripSection" class="hidden conditional-section">
    <h3 class="section-subtitle">Détails du voyage retour</h3>
    
    <div class="form-group">
        <label>60. Est-ce que l'employeur a supporté le voyage retour du travailleur vers le lieu où il avait recruté? :</label>
        <select id="returnTripSupport">
            <option value="">-- Sélectionnez --</option>
            <option value="OUI en totalité">OUI en totalité</option>
            <option value="OUI mais en partie">OUI mais en partie</option>
            <option value="NON PAS DU TOUT">NON PAS DU TOUT</option>
        </select>
    </div>
    
    <div id="returnTripCostSection" class="hidden conditional-section">
        <div class="form-group">
            <label>61. Combien coute ou a coûté effectivement le voyage retour du travailleur :</label>
                
            <div class="form-group">
                <label for="returnTripCurrency">a) Monnaie :</label>
                <select id="returnTripCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="returnTripCost">b) Montant :</label>
                <input type="number" id="returnTripCost" min="0" step="0.01">
            </div>
        </div>
    </div>
    
    <div id="partialReturnTripSection" class="hidden conditional-section">
        <div class="form-group">
            <label>62. Combien l'employeur a effectivement payé pour supporter le voyage retour :</label>
            
            <div class="form-group">
                <label for="employerPaidCurrency">a) Monnaie :</label>
                <select id="employerPaidCurrency">
                    <option value="">-- Sélectionnez --</option>
                    <option value="francs congolais">francs congolais</option>
                    <option value="dollars américains">dollars américains</option>
                    <option value="euro">Euro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="employerPaidAmount">b) Montant :</label>
                <input type="number" id="employerPaidAmount" min="0" step="0.01">
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label for="returnTripWaitingDays">63. Combien de jours le travailleur a attendu pour qu'on lui assure le voyage retour? :</label>
        <input type="number" id="returnTripWaitingDays" min="0">
    </div>
</div>

<div class="btn-container">
    <button class="btn-secondary" id="backToPage9">
        <i class="fas fa-arrow-left"></i> Précédent
    </button>
    <button class="btn-primary" id="nextToPage11">
        Suivant <i class="fas fa-arrow-right"></i>
    </button>
</div>
</div>

<!-- Page 11: Social Security -->
<div class="page" id="page11">
<h2 class="page-title"><i class="fas fa-shield-alt"></i> Avantages de fin de carrière et sécurité sociale</h2>

<div class="form-group">
    <label for="endOfCareerBenefit">63b. Si le contrat de travail, la convention collective ou le règlement d'entreprise prévoit un ou plusieurs avantages de fin de carrière, indiquez la valeur en argent de ces avantages :</label>
    <input type="number" id="endOfCareerBenefit" min="0" step="0.01" required>
    <small class="form-hint">Mettez 0 si aucun avantage n'est prévu</small>
</div>

<div class="form-group">
    <label for="endOfCareerCurrency">63c. Quelle est la monnaie de cette valeur :</label>
    <select id="endOfCareerCurrency" required>
        <option value="">-- Sélectionnez --</option>
        <option value="francs congolais">francs congolais</option>
        <option value="dollars américains">dollars américains</option>
        <option value="euro">Euro</option>
    </select>
</div>

<div class="form-group">
    <label>64. Le travailleur est-il immatriculé à la CNSS :</label>
    <div class="radio-group">
        <label><input type="radio" name="socialSecurityRegistered" value="OUI"> OUI</label>
        <label><input type="radio" name="socialSecurityRegistered" value="NON" checked> NON</label>
    </div>
</div>

<div id="socialSecuritySection" class="hidden conditional-section">
    <h3 class="section-subtitle">Détails de l'immatriculation à la sécurité sociale</h3>
    
    <div class="form-group">
        <label>65. Depuis quelle année et quel mois le travailleur est immatriculé à la sécurité sociale ?</label>
        
        <div class="form-group">
            <label for="registrationYear">a) Année :</label>
            <input type="number" id="registrationYear" min="1960" step="1" 
                placeholder="Ex: 2020">
            <small class="form-hint">Entre 1960 et l'année en cours</small>
        </div>
        
        <div class="form-group">
            <label for="registrationMonth">b) Mois :</label>
            <select id="registrationMonth">
                <option value="">-- Sélectionnez --</option>
                <option value="janvier">janvier</option>
                <option value="février">février</option>
                <option value="mars">mars</option>
                <option value="avril">avril</option>
                <option value="mai">mai</option>
                <option value="juin">juin</option>
                <option value="juillet">juillet</option>
                <option value="août">août</option>
                <option value="septembre">septembre</option>
                <option value="octobre">octobre</option>
                <option value="novembre">novembre</option>
                <option value="décembre">décembre</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label for="contributionMonths">66. Combien de mois de cotisation le travailleur a payé à la sécurité sociale ?</label>
        <input type="number" id="contributionMonths" min="0">
    </div>
</div>

<div class="btn-container">
    <button class="btn-secondary" id="backToPage10">
        <i class="fas fa-arrow-left"></i> Précédent
    </button>
    <button class="btn-primary" id="nextToPage12">
        Suivant <i class="fas fa-arrow-right"></i>
    </button>
</div>
</div>

<!-- Page 12: Email -->
<div class="page" id="page12">
    <h2 class="page-title"><i class="fas fa-envelope"></i> Email pour recevoir la réponse détaillée</h2>
    
    <div class="form-section">
        <p>Veuillez fournir votre adresse email pour recevoir les résultats détaillés du calcul.</p>
        
        <div class="form-group">
            <label for="clientEmail">67. Votre adresse électronique :</label>
            <input type="email" id="clientEmail" required placeholder="votre@email.com">
        </div>
    </div>
    
    <div class="btn-container">
        <button class="btn-secondary" id="backToPage11">
            <i class="fas fa-arrow-left"></i> Précédent
        </button>
        <button class="btn-primary" id="nextToPage14">
            Suivant <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Page 14: Review and Submit -->
<div class="page" id="page14">
    <h2 class="page-title"><i class="fas fa-clipboard-check"></i> Revue des Réponses</h2>
    
    <div class="form-section">
        <p>Vérifiez vos réponses avant de procéder au paiement. Cliquez sur "Modifier" à côté de toute réponse que vous souhaitez corriger.</p>
    </div>
    
    <div id="reviewContent" class="review-container">
        <!-- Le contenu sera généré dynamiquement -->
    </div>
    
    <div class="btn-container">
        <button class="btn-secondary" id="backToPage12">
            <i class="fas fa-arrow-left"></i> Précédent
        </button>
        <button class="btn-primary" id="nextToPage15">
            Paiement <i class="fas fa-credit-card"></i>
        </button>
    </div>
</div>

<!-- Page 15: Paiement Lygos -->
<div class="page" id="page15">
    <h2 class="page-title"><i class="fas fa-credit-card"></i> Paiement Mobile Money via Lygos</h2>
    
    <div class="payment-info">
        <h3 class="section-subtitle">Détails du paiement</h3>
        <p>Montant à payer : <strong>10,000 francs congolais</strong> ou <strong>3.5$ USD</strong></p>
        <p>Vous serez redirigé vers l'interface de paiement sécurisée Lygos. Après le paiement, vous recevrez instantanément les résultats par email.</p>
    </div>
    
    <!-- Section d'état de paiement -->
    <div id="paymentStatus" class="payment-status hidden"></div>
    
    <div class="btn-container">
        <button class="btn-secondary" id="backToPage14">
            <i class="fas fa-arrow-left"></i> Précédent
        </button>
        <button class="btn-success" id="startPaymentBtn">
            <i class="fas fa-lock"></i> Effectuer le paiement sécurisé
        </button>
    </div>
    
    <div id="paymentSuccessSection" class="hidden conditional-section">
        <h3 class="section-subtitle">Paiement réussi</h3>
        
        <div class="form-group">
            <label for="paymentId">68. Référence de transaction Lygos :</label>
            <input type="text" id="paymentId" readonly>
        </div>
        
        <div class="btn-container">
            <button class="btn-primary" id="submitBtn">
                <i class="fas fa-paper-plane"></i> Envoyer le formulaire
            </button>
        </div>
    </div>
</div>

<!-- Page 16: Échec du paiement -->
<div class="page" id="page16">
    <h2 class="page-title"><i class="fas fa-exclamation-triangle"></i> Échec du Paiement</h2>
    
    <div class="error-state">
        <div class="error-icon">
            <i class="fas fa-times-circle"></i>
        </div>
        <h3>Paiement non validé</h3>
        <div class="error-message">
            Votre paiement n'a pas pu être traité.
        </div>
        
        <div id="paymentErrorDetails">
            <!-- Les détails seront injectés par JavaScript -->
        </div>
        
        <div class="error-actions">
            <button id="retryPaymentBtn" class="btn-warning">
                <i class="fas fa-redo"></i> Réessayer le paiement
            </button>
            <button id="backToFormBtn" class="btn-secondary">
                <i class="fas fa-edit"></i> Retour au formulaire
            </button>
        </div>
    </div>
</div>

<!-- Page 17 : Résultats -->
<div class="page" id="pageResult">
    <h2 class="page-title"><i class="fas fa-chart-line"></i> Résultats du calcul</h2>
    
    <div class="result-card">
        <div id="resultContent">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Traitement en cours...</p>
            </div>
        </div>
    </div>
    
    <div class="result-actions">
        <button class="btn-secondary" id="newCalculationBtn" disabled>
            <i class="fas fa-calculator"></i> Nouveau calcul
        </button>
        <div class="contact-links">
            <a href="mailto:nsolotshi3@gmail.com?subject=Demande%20d'informations&body=Bonjour,%0AJe%20souhaite%20avoir%20des%20renseignements." class="contact-link email">
                <i class="fas fa-envelope"></i> Contact
            </a>
        </div>
    </div>
</div>

<!-- Bouton d'installation PWA -->
<button id="installButton" class="install-btn" style="display: none;">
    <i class="fas fa-download"></i> Installer l'application
</button>
</div>

<script>
// ==================== AMÉLIORATIONS PWA ====================

// Vérifier si le navigateur supporte les PWA
function checkPWACompatibility() {
  return ('serviceWorker' in navigator) && ('BeforeInstallPromptEvent' in window);
}

// Enregistrer le Service Worker
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js');
      console.log('SW registered: ', registration);
      
      // Vérifier s'il y a une mise à jour en attente
      if (registration.waiting) {
        console.log('New service worker waiting');
        // Vous pourriez afficher un message à l'utilisateur ici
      }
      
      // Écouter les mises à jour
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        console.log('New service worker installing');
        
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed') {
            console.log('New service worker installed');
            // Vous pourriez afficher un message à l'utilisateur ici
          }
        });
      });
      
      return registration;
    } catch (error) {
      console.error('SW registration failed: ', error);
      return null;
    }
  }
  return null;
}

// Vérifier si l'app est déjà installée
function checkIfAppIsInstalled() {
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('App is running in standalone mode');
    if (installButton) {
      installButton.style.display = 'none';
    }
    return true;
  }
  
  // Vérification pour iOS
  if (window.navigator.standalone === true) {
    console.log('App is running in iOS standalone mode');
    if (installButton) {
      installButton.style.display = 'none';
    }
    return true;
  }
  
  return false;
}

// Fonction pour déclencher l'installation
function installApp() {
  if (!deferredPrompt) {
    console.log('No deferred prompt available');
    showInstallInstructions();
    return;
  }
  
  // Afficher l'invite d'installation
  deferredPrompt.prompt();
  
  // Attendre que l'utilisateur réponde à l'invite
  deferredPrompt.userChoice.then((choiceResult) => {
    if (choiceResult.outcome === 'accepted') {
      console.log('User accepted the install prompt');
      // Cacher le bouton d'installation après acceptation
      if (installButton) {
        installButton.style.display = 'none';
      }
    } else {
      console.log('User dismissed the install prompt');
    }
    
    // Réinitialiser deferredPrompt
    deferredPrompt = null;
  });
}

// Fonction pour afficher les instructions d'installation manuelle
function showInstallInstructions() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isAndroid = /Android/.test(navigator.userAgent);
  
  if (isIOS) {
    alert("Pour installer cette application sur iOS:\n\n1. Ouvrez Safari\n2. Appuyez sur le bouton de partage (⎗)\n3. Faites défiler vers le bas et sélectionnez 'Sur l'écran d'accueil'\n4. Appuyez sur 'Ajouter'");
  } else if (isAndroid) {
    alert("Pour installer cette application sur Android:\n\n1. Ouvrez le menu du navigateur (⋮)\n2. Sélectionnez 'Installer l'application' ou 'Ajouter à l'écran d'accueil'\n3. Confirmez l'installation");
  } else {
    alert("Pour installer cette application:\n\nAndroid: Ouvrez le menu du navigateur (⋮) et sélectionnez 'Installer l'application' ou 'Ajouter à l'écran d'accueil'\n\niOS: Utilisez le bouton de partage (⎗) et sélectionnez 'Sur l'écran d'accueil'");
  }
}

// Mettre à jour l'initialisation de l'application
function initializeApplication() {
  // ... code existant ...
  
  // Initialiser PWA
  initializePWA();
  
  // ... reste du code existant ...
}

// Mettre à jour la fonction initializePWA
function initializePWA() {
  if (!checkPWACompatibility()) {
    console.log('PWA features not supported in this browser');
    return;
  }
  
  // Enregistrer le Service Worker
  registerServiceWorker();
  
  // Vérifier si l'app est déjà installée
  checkIfAppIsInstalled();
  
  // Gérer l'installation de l'application
  const installButton = document.getElementById('installButton');
  
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('beforeinstallprompt event fired');
    
    // Empêcher le mini-infobar d'apparaître sur mobile
    e.preventDefault();
    
    // Stocker l'événement pour qu'il puisse être déclenché plus tard
    deferredPrompt = e;
    
    // Afficher le bouton d'installation
    if (installButton) {
      installButton.style.display = 'block';
      installButton.addEventListener('click', installApp);
    }
    
    console.log('PWA installation available');
  });

  window.addEventListener('appinstalled', () => {
    console.log('App was successfully installed');
    
    // Masquer le bouton d'installation
    if (installButton) {
      installButton.style.display = 'none';
    }
    
    // Réinitialiser deferredPrompt
    deferredPrompt = null;
  });
}
// ==================== AUTRES FONCTIONS EXISTANTES ====================
// (Vos autres fonctions JavaScript restent ici)

// ==================== CONFIGURATION ====================
const LYGS_API_KEY = "lygosapp-d8883309-1c81-4448-a847-98088df32121";
const PAYMENT_AMOUNT = 10000;
const SHOP_NAME = "Jurisconsulte-Rdc";
const PAYMENT_DESCRIPTION = "Paiement pour le calcul du décompte final";
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwKLC6QB_EXg4Fcf8xeVP84IRN5wrdW7CiTcOIyI0W7Bvd1ujwFASAd2ydSc7rFc70/exec';

// ==================== VARIABLES GLOBALES ====================
let currentPage = 1;
const totalPages = 16; // 16 pages au total (sans compter la page de résultats)
let isSubmitting = false;
let deferredPrompt = null; // Pour l'installation PWA
// Pour l'installation PWA
// ==================== MISE À JOUR DE LA BARRE DE PROGRESSION ====================
function updateProgressBar() {
    // Calcul du pourcentage de progression
    let progressPercentage;
    
    if (currentPage === 1) {
        progressPercentage = 0;
    } else if (currentPage >= 14) {
        // À partir de la page 14 (révision), on considère que c'est presque terminé
        progressPercentage = 95;
    } else {
        // Progression linéaire pour les pages 2 à 13
        progressPercentage = Math.min(95, ((currentPage - 1) / (totalPages - 1)) * 100);
    }
    
    // Mise à jour de la barre de progression
    document.getElementById('progressBar').style.width = `${progressPercentage}%`;
    
    // Mise à jour du texte de progression
    const currentStepElement = document.getElementById('currentStep');
    const progressPercentageElement = document.getElementById('progressPercentage');
    
    if (currentStepElement) {
        currentStepElement.textContent = `Étape ${currentPage} sur ${totalPages}`;
    }
    
    if (progressPercentageElement) {
        progressPercentageElement.textContent = `${Math.round(progressPercentage)}%`;
    }
}

// ==================== NAVIGATION ====================
function navigateToPage(pageId) {
    if (typeof pageId === 'string') {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        return;
    }
    
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    const targetPage = document.getElementById(`page${pageId}`);
    if (targetPage) {
        targetPage.classList.add('active');
        currentPage = pageId;
        updateProgressBar();
        window.scrollTo(0, 0);
    }
}

function nextPage() {
    if (!validateCurrentPage()) {
        return;
    }

    document.getElementById(`page${currentPage}`).classList.remove('active');
    
    const q16Value = document.querySelector('input[name="sameLocation"]:checked')?.value;

    if (currentPage === 9 && q16Value === 'OUI') {
        currentPage = 11;
    } else if (currentPage === 12) {
        currentPage = 14;
    } else if (currentPage === 14) {
        generateReviewContent();
    } else if (currentPage === 13) {
        currentPage = 14;
    } else {
        currentPage++;
    }
    
    document.getElementById(`page${currentPage}`).classList.add('active');
    updateProgressBar();
    
    if (currentPage === 14) {
        generateReviewContent();
    }
}

function prevPage() {
    document.getElementById(`page${currentPage}`).classList.remove('active');
    
    if (currentPage === 11 && document.querySelector('input[name="sameLocation"]:checked')?.value === 'OUI') {
        currentPage = 9;
    } else {
        currentPage--;
    }
    
    document.getElementById(`page${currentPage}`).classList.add('active');
    updateProgressBar();
}

// ==================== VALIDATION DU FORMULAIRE ====================
function validateCurrentPage() {
    const currentPageElement = document.getElementById(`page${currentPage}`);
    // Ne vérifier que les champs visibles et requis
    const requiredInputs = currentPageElement.querySelectorAll('[required]:not(.hidden [required])');
    
    for (const input of requiredInputs) {
        // Vérifier si le champ est dans une section cachée
        if (input.closest('.hidden')) continue;
        
        if (!input.value) {
            alert('Veuillez remplir tous les champs obligatoires.');
            input.focus();
            return false;
        }
    }
    
    // Validation spécifique pour la page 8
    if (currentPage === 8) {
        const annualLeaveTaken = document.getElementById('annualLeaveTaken');
        const leaveValue = parseInt(annualLeaveTaken.value);
        
        if (isNaN(leaveValue)) {
            alert("Veuillez entrer un nombre de congés valide (0, 1 ou 2)");
            annualLeaveTaken.focus();
            return false;
        }
        
        if (leaveValue < 0 || leaveValue > 2) {
            alert("Le nombre de congés pris doit être 0, 1 ou 2 maximum");
            annualLeaveTaken.focus();
            annualLeaveTaken.value = '';
            return false;
        }
        
        // Vérifier si les avantages de congé sont activés
        const benefitsEnabled = document.querySelector('input[name="leaveBenefits"]:checked')?.value === 'OUI';
        
        // Validation conditionnelle pour Q52 et Q53 - SEULEMENT si Q50=OUI
        if (benefitsEnabled) {
            if (leaveValue === 1) {
                const oneBenefit = document.getElementById('oneLeaveBenefitReceived');
                if (!oneBenefit.value) {
                    alert("Veuillez remplir le champ Q52 (avantages pour un congé)");
                    oneBenefit.focus();
                    return false;
                }
            } else if (leaveValue === 2) {
                const twoBenefits = document.getElementById('twoLeaveBenefitsReceived');
                if (!twoBenefits.value) {
                    alert("Veuillez remplir le champ Q53 (avantages pour deux congés)");
                    twoBenefits.focus();
                    return false;
                }
            }
        }
    }

    
    // Autres validations existantes...
    if (currentPage === 4) {
        const startDate = new Date(document.getElementById('contractStartDate').value);
        const endDate = new Date(document.getElementById('contractEndDate').value);
        
        if (endDate < startDate) {
            alert('La date de rupture du contrat ne peut pas être antérieure à la date de conclusion du contrat.');
            return false;
        }
    }
    
    if (currentPage === 4) {
        const terminationDate = document.getElementById('contractEndDate').value;
        const faultDate = document.getElementById('faultKnowledgeDate').value;
        
        if (faultDate && terminationDate) {
            const terminationDateObj = new Date(terminationDate);
            const faultDateObj = new Date(faultDate);
            
            if (faultDateObj > terminationDateObj) {
                alert("La date de connaissance des faits (Q22) ne peut pas être postérieure à la date de rupture du contrat (Q13)");
                document.getElementById('faultKnowledgeDate').focus();
                return false;
            }
        }
    }
    
    if (currentPage === 4) {
        const daysInput = document.getElementById('workDaysPerWeek');
        const daysValue = parseInt(daysInput.value);
        
        if (isNaN(daysValue) || daysValue < 1 || daysValue > 7) {
            alert("Le nombre de jours de travail doit être entre 1 et 7");
            daysInput.focus();
            daysInput.value = '';
            return false;
        }
    }
    // Validation spécifique pour la page 11 (CNSS)
    if (currentPage === 11) {
        const isSocialSecurityRegistered = document.querySelector('input[name="socialSecurityRegistered"]:checked')?.value === 'OUI';
        const socialSecuritySection = document.getElementById('socialSecuritySection');
        const isSectionVisible = socialSecuritySection && !socialSecuritySection.classList.contains('hidden');
        
        if (isSocialSecurityRegistered && isSectionVisible) {
            const registrationYear = document.getElementById('registrationYear').value;
            const registrationMonth = document.getElementById('registrationMonth').value;
            const contributionMonths = document.getElementById('contributionMonths').value;
            
            // Validation pour Q65a (champ numérique)
            if (!registrationYear) {
                alert("Veuillez saisir l'année d'immatriculation à la CNSS");
                document.getElementById('registrationYear').focus();
                return false;
            }
            
            const yearValue = parseInt(registrationYear);
            const currentYear = new Date().getFullYear();
            
            // Dans validateCurrentPage(), remplacer la validation de Q65a par:
            if (!validateRegistrationYear(document.getElementById('registrationYear'))) {
                alert("Veuillez saisir une année valide entre 1960 et " + new Date().getFullYear());
                document.getElementById('registrationYear').focus();
                document.getElementById('registrationYear').select();
                return false;
            }
            
            if (!registrationMonth || registrationMonth === "") {
                alert("Veuillez sélectionner un mois d'immatriculation à la CNSS");
                document.getElementById('registrationMonth').focus();
                return false;
            }
            
            if (!contributionMonths) {
                alert("Veuillez indiquer le nombre de mois de cotisation à la CNSS");
                document.getElementById('contributionMonths').focus();
                return false;
            }
        }
    }

    return true;
}

function validateWorkDays(input) {
    const value = parseInt(input.value);
    
    if (isNaN(value)) {
        input.setCustomValidity("Veuillez entrer un nombre valide");
    } else if (value < 1) {
        input.value = 1;
        input.setCustomValidity("");
    } else if (value > 7) {
        input.value = 7;
        input.setCustomValidity("");
    } else {
        input.setCustomValidity("");
    }
    input.reportValidity();
}

function validateDailyHours(input) {
    const value = parseInt(input.value);
    
    if (isNaN(value)) {
        input.setCustomValidity("Veuillez entrer un nombre valide");
    } else if (value < 1) {
        input.value = 1;
        input.setCustomValidity("");
    } else if (value > 24) {
        input.value = 24;
        input.setCustomValidity("");
    } else {
        input.setCustomValidity("");
    }
    input.reportValidity();
}

// ==================== GESTION DES DONNÉES DU FORMULAIRE ====================
function saveFormData() {
    const formData = {};
    
    document.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.type === 'radio' || field.type === 'checkbox') {
            if (field.checked) {
                formData[field.name || field.id] = field.value;
            }
        } else {
            formData[field.name || field.id] = field.value;
        }
    });
    
    localStorage.setItem('nsolotshicapp_form_data', JSON.stringify(formData));
}

function restoreFormData() {
    const savedData = localStorage.getItem('nsolotshicapp_form_data');
    if (!savedData) return;
    
    const formData = JSON.parse(savedData);
    
    for (const [key, value] of Object.entries(formData)) {
        const field = document.querySelector(`[name="${key}"], #${key}`);
        if (!field) continue;
        
        if (field.type === 'radio' || field.type === 'checkbox') {
            if (field.value === value) {
                field.checked = true;
                field.dispatchEvent(new Event('change'));
            }
        } else {
            field.value = value;
        }
    }
    
    setTimeout(initializeAllConditions, 100);
}

function setupAutoSave() {
    document.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', saveFormData);
        field.addEventListener('change', saveFormData);
    });
}

function clearSavedFormData() {
    localStorage.removeItem('nsolotshicapp_form_data');
}

// ==================== FONCTION DE SOUMISSION ====================
async function submitForm(event) {
    if (isSubmitting) {
        event.preventDefault();
        return;
    }
    
    isSubmitting = true;
    if (event) event.preventDefault();
    
    // Afficher la page de résultats immédiatement avec un message de chargement
    navigateToPage('pageResult');
    document.getElementById('resultContent').innerHTML = `
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Traitement en cours... Veuillez patienter</p>
            <p>Cette opération peut prendre quelques secondes</p>
        </div>
    `;
    
    // Désactiver le bouton Nouveau Calcul pendant l'envoi
    document.getElementById('newCalculationBtn').disabled = true;
    
    try {
        const rawData = collectFlattenedFormData();
        
        // Envoyer les données au serveur sans attendre de réponse
        sendDataToServer(rawData).then(response => {
            // Attendre 5 secondes avant d'afficher le message de confirmation
            setTimeout(() => {
                // Afficher le message de confirmation même si le serveur ne répond pas
                displayConfirmationMessage({
                    success: true,
                    message: "Vos données ont été envoyées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                    submissionId: rawData.submissionId || "inconnu",
                    timestamp: new Date().toISOString()
                });
                
                // Effacer les données sauvegardées après succès
                clearSavedFormData();
            }, 5000); // 5000 ms = 5 secondes
        }).catch(error => {
            console.error("Erreur lors de l'envoi des données:", error);
            // Attendre 5 secondes même en cas d'erreur
            setTimeout(() => {
                // Afficher quand même un message de succès (mode optimiste)
                displayConfirmationMessage({
                    success: true,
                    message: "Vos données ont été traitées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                    submissionId: rawData.submissionId || "inconnu",
                    timestamp: new Date().toISOString()
                });
                
                // Effacer les données sauvegardées
                clearSavedFormData();
            }, 5000);
        });
        
    } catch (error) {
        console.error("Erreur lors de la soumission:", error);
        // En cas d'erreur, attendre aussi 5 secondes
        setTimeout(() => {
            displayConfirmationMessage({
                success: false,
                message: "Erreur de traitement des données. Veuillez réessayer."
            });
        }, 5000);
    } finally {
        // Ne pas définir isSubmitting à false immédiatement
        // pour éviter les soumissions multiples pendant le délai
        setTimeout(() => {
            isSubmitting = false;
        }, 5000);
    }
}

// ==================== COLLECTE DES DONNÉES DU FORMULAIRE ====================
function collectFlattenedFormData() {
    const data = {};
    // Générer un ID unique pour la soumission
    data['submissionId'] = `NSOLOTSHICAPP-${new Date().getTime()}-${Math.floor(Math.random() * 10000)}`;
    data['submissionDate'] = new Date().toISOString();
    data['clientEmail'] = document.getElementById('clientEmail').value;
    data['Q1'] = document.getElementById('employerName').value;
    data['Q2'] = document.getElementById('employerLocation').value;
    data['Q3'] = document.getElementById('workerName').value;
    data['Q4'] = document.getElementById('birthDate').value;
    data['Q5'] = document.querySelector('input[name="gender"]:checked')?.value || '';
    data['Q6'] = document.getElementById('maritalStatus').value;
    data['Q7'] = parseInt(document.getElementById('childrenCount').value) || 0;
    data['Q8'] = document.querySelector('input[name="contractType"]:checked')?.value || '';
    data['Q9'] = document.querySelector('input[name="indefiniteContract"]:checked')?.value === 'OUI';
    data['Q10'] = document.getElementById('contractStartDate').value;
    data['Q11'] = document.getElementById('recruitmentLocation').value;
    data['Q12'] = parseInt(document.getElementById('workDaysPerWeek').value) || 0;
    data['Q13'] = document.getElementById('contractEndDate').value;
    data['Q14'] = document.getElementById('terminationLocation').value;
    data['Q15'] = document.getElementById('lastAssignment').value;
    data['Q16'] = document.querySelector('input[name="sameLocation"]:checked')?.value === 'OUI';
    data['Q17'] = document.getElementById('terminationParty').value;
    data['Q18'] = document.querySelector('input[name="writtenDecision"]:checked')?.value || '';
    data['Q19'] = parseInt(document.getElementById('noticePeriodDays').value) || 0;
    data['Q20'] = document.getElementById('terminationReason').value;
    data['Q21'] = document.querySelector('input[name="workInspectorAuthorization"]:checked')?.value || '';
    data['Q22'] = document.getElementById('faultKnowledgeDate').value;
    data['Q23'] = document.getElementById('terminationMotivationEvaluation').value;
    data['Q24'] = document.getElementById('resignationReason').value;
    data['Q25'] = document.getElementById('workerComplaintsEvaluation').value;
    data['Q26'] = document.getElementById('workerCategory').value;
    data['Q26bis'] = parseInt(document.getElementById('monthsInCategory').value) || 0;
    data['Q27'] = document.getElementById('categoryHelp').value;
    data['Q28'] = document.getElementById('workRegime').value;
    data['Q29'] = parseInt(document.getElementById('dailyWorkHours').value) || 0;
    data['Q30'] = document.querySelector('input[name="unpaidOvertime"]:checked')?.value === 'OUI';
    data['Q31'] = parseInt(document.getElementById('totalOvertimeHours').value) || 0;
    data['Q32a'] = parseInt(document.getElementById('sundayOvertime').value) || 0;
    data['Q32b'] = parseInt(document.getElementById('holidayOvertime').value) || 0;
    data['Q32c'] = parseInt(document.getElementById('firstWeeklyOvertime').value) || 0;
    data['Q32d'] = parseInt(document.getElementById('remainingOvertime').value) || 0;
    data['Q33a'] = document.getElementById('salaryCurrency').value;
    data['Q33b'] = parseFloat(document.getElementById('monthlySalary').value) || 0;
    data['Q33c'] = parseFloat(document.getElementById('monthlyTransport').value) || 0;
    data['Q33d'] = parseFloat(document.getElementById('monthlyHousing').value) || 0;
    data['Q33e'] = parseFloat(document.getElementById('monthlyFamilyAllowance').value) || 0;
    data['Q34a'] = parseFloat(document.getElementById('unpaidAmount').value) || 0;
    data['Q34b'] = document.getElementById('unpaidCurrency').value;
    data['Q35'] = document.getElementById('commuteDistance').value;
    data['Q36'] = document.getElementById('transportProvision').value;
    data['Q37a'] = document.getElementById('dailyTransportCurrency').value;
    data['Q37b'] = parseFloat(document.getElementById('dailyTransportCost').value) || 0;
    data['Q38'] = document.querySelector('input[name="housingProvided"]:checked')?.value === 'OUI';
    data['Q39a'] = document.getElementById('housingCurrency').value;
    data['Q39b'] = parseFloat(document.getElementById('monthlyHousingCost').value) || 0;
    data['Q40'] = document.querySelector('input[name="familyAllowancePaid"]:checked')?.value === 'OUI';
    data['Q41a'] = document.getElementById('familyAllowanceCurrency').value;
    data['Q41b'] = parseFloat(document.getElementById('actualFamilyAllowance').value) || 0;
    data['Q42'] = document.querySelector('input[name="healthcareProvided"]:checked')?.value === 'OUI';
    data['Q43'] = document.querySelector('input[name="unpaidMedicalBills"]:checked')?.value === 'OUI';
    data['Q44a'] = document.getElementById('medicalBillsCurrency').value;
    data['Q44b'] = parseFloat(document.getElementById('medicalBillsAmount').value) || 0;
    data['Q45'] = document.querySelector('input[name="businessTrips"]:checked')?.value === 'OUI';
    data['Q46a'] = document.getElementById('businessTripsCurrency').value;
    data['Q46b'] = parseFloat(document.getElementById('businessTripsAmount').value) || 0;
    data['Q47'] = parseInt(document.getElementById('annualLeaveTaken').value) || 0;
    data['Q48'] = document.querySelector('input[name="annualLeaveDefined"]:checked')?.value === 'OUI';
    data['Q49'] = parseInt(document.getElementById('definedAnnualLeaveDays').value) || 0;
    data['Q50'] = document.querySelector('input[name="leaveBenefits"]:checked')?.value === 'OUI';
    data['Q51a'] = parseFloat(document.getElementById('leaveBenefitAmount').value) || 0;
    data['Q51b'] = document.getElementById('leaveBenefitCurrency').value;
    data['Q52'] = parseFloat(document.getElementById('oneLeaveBenefitReceived').value) || 0;
    data['Q53'] = parseFloat(document.getElementById('twoLeaveBenefitsReceived').value) || 0;
    data['Q54'] = document.querySelector('input[name="noticePeriodServed"]:checked')?.value === 'OUI';
    data['Q55'] = parseInt(document.getElementById('noticePeriodDaysPage9').value) || 0;
    data['Q56a'] = document.getElementById('noticePaymentCurrency').value;
    data['Q56b'] = parseFloat(document.getElementById('noticePaymentAmount').value) || 0;
    data['Q57'] = document.querySelector('input[name="noticeCompensation"]:checked')?.value === 'OUI';
    data['Q58a'] = document.getElementById('compensationCurrency').value;
    data['Q58b'] = parseFloat(document.getElementById('compensationAmount').value) || 0;
    data['Q59'] = document.querySelector('input[name="returnTripRequested"]:checked')?.value === 'OUI';
    data['Q60'] = document.getElementById('returnTripSupport').value;
    data['Q61a'] = document.getElementById('returnTripCurrency').value;
    data['Q61b'] = parseFloat(document.getElementById('returnTripCost').value) || 0;
    data['Q62a'] = document.getElementById('employerPaidCurrency').value;
    data['Q62b'] = parseFloat(document.getElementById('employerPaidAmount').value) || 0;
    data['Q63'] = parseInt(document.getElementById('returnTripWaitingDays').value) || 0;
    data['Q63b'] = parseFloat(document.getElementById('endOfCareerBenefit').value) || 0;
    data['Q63c'] = document.getElementById('endOfCareerCurrency').value;
    data['Q64'] = document.querySelector('input[name="socialSecurityRegistered"]:checked')?.value === 'OUI';
    data['Q65a'] = document.getElementById('registrationYear').value;
    data['Q65b'] = document.getElementById('registrationMonth').value;
    data['Q66'] = parseInt(document.getElementById('contributionMonths').value) || 0;
    data['Q67'] = document.getElementById('clientEmail').value;
    data['Q68'] = document.getElementById('paymentId').value;
    
    const paymentData = JSON.parse(localStorage.getItem('paymentData')) || {};
    data.paymentTransactionId = paymentData.transactionId;
    data.paymentAmount = paymentData.amount;
    data.paymentCurrency = paymentData.currency;
    data.paymentDate = paymentData.date;
    data.paymentStatus = paymentData.status;

    return data;
}

// ==================== ENVOI DES DONNÉES AU SERVEUR ====================
async function sendDataToServer(formDataObject) {
    // Récupération des données de paiement
    const paymentData = JSON.parse(localStorage.getItem('paymentData') || '{}');
    
    // Ajouter les données de paiement à l'objet formDataObject
    if (paymentData.transactionId) {
        formDataObject.paymentTransactionId = paymentData.transactionId;
        formDataObject.paymentAmount = paymentData.amount || '';
        formDataObject.paymentCurrency = paymentData.currency || '';
        formDataObject.paymentDate = paymentData.date || '';
        formDataObject.paymentStatus = paymentData.status || 'COMPLETED';
    } else {
        formDataObject.paymentStatus = paymentData.status || 'NOT_PAID';
    }

    try {
        console.log('Données à envoyer:', formDataObject);
        
        const formData = new URLSearchParams();
        for (const key in formDataObject) {
            if (formDataObject[key] !== null && formDataObject[key] !== undefined) {
                formData.append(key, formDataObject[key].toString());
            }
        }
        
        // Envoyer les données sans attendre de réponse
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Mode no-cors pour éviter les erreurs CORS
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
        }).catch(error => {
            console.log("Données envoyées au serveur (mode no-cors, réponse non traitée)");
        });
        
        return {success: true};
        
    } catch (error) {
        console.error("Erreur lors de l'envoi des données:", error);
        throw error;
    }
}

// ==================== FONCTIONS POUR GÉRER LES CHAMPS CONDITIONNELS ====================
function setRequiredForSection(sectionId, isRequired) {
    const section = document.getElementById(sectionId);
    if (!section || section.classList.contains('hidden')) return;
    
    const inputs = section.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (isRequired) {
            input.setAttribute('required', 'required');
        } else {
            input.removeAttribute('required');
        }
    });
}

// ==================== FONCTION AMÉLIORÉE POUR EFFACER LES DONNÉES ====================
function clearSectionData(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    
    const inputs = section.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.type === 'text' || input.type === 'email' || input.type === 'number' || input.tagName === 'SELECT' || input.type === 'textarea') {
            input.value = '';
            // Déclencher l'événement change pour mettre à jour les conditions dépendantes
            input.dispatchEvent(new Event('change'));
        } else if (input.type === 'radio' || input.type === 'checkbox') {
            input.checked = false;
            // Déclencher l'événement change pour mettre à jour les conditions dépendantes
            input.dispatchEvent(new Event('change'));
        }
    });
    
    // Sauvegarder les modifications
    saveFormData();
}

// ==================== MODIFICATION SPÉCIFIQUE POUR LA PAGE 8 ====================
function setupPage8SpecificLogic() {
    // Gestion spécifique pour les congés annuels
    const annualLeaveTaken = document.getElementById('annualLeaveTaken');
    const leaveBenefits = document.querySelector('input[name="leaveBenefits"]');
    
    function updateLeaveBenefitsVisibility() {
        const leaveValue = parseInt(annualLeaveTaken.value);
        const benefitsEnabled = document.querySelector('input[name="leaveBenefits"]:checked')?.value === 'OUI';
        
        // Q52 doit s'afficher seulement si Q47=1 ET Q50=OUI
        const showOne = (leaveValue === 1) && benefitsEnabled;
        // Q53 doit s'afficher seulement si Q47=2 ET Q50=OUI
        const showTwo = (leaveValue === 2) && benefitsEnabled;
        
        // Masquer/afficher les sections
        document.getElementById('oneLeaveBenefitSection').classList.toggle('hidden', !showOne);
        document.getElementById('twoLeaveBenefitsSection').classList.toggle('hidden', !showTwo);
        
        // Gérer les attributs required
        setRequiredForSection('oneLeaveBenefitSection', showOne);
        setRequiredForSection('twoLeaveBenefitsSection', showTwo);
        
        // Effacer les données des sections cachées
        if (!showOne) clearSectionData('oneLeaveBenefitSection');
        if (!showTwo) clearSectionData('twoLeaveBenefitsSection');
    }
    
    if (annualLeaveTaken) {
        annualLeaveTaken.addEventListener('change', updateLeaveBenefitsVisibility);
    }
    
    if (leaveBenefits) {
        // Ajouter des écouteurs pour tous les boutons radio de leaveBenefits
        document.querySelectorAll('input[name="leaveBenefits"]').forEach(radio => {
            radio.addEventListener('change', updateLeaveBenefitsVisibility);
        });
    }
    
    // S'assurer que les sections sont correctement initialisées
    const initialLeaveValue = parseInt(annualLeaveTaken.value);
    const initialBenefitsEnabled = document.querySelector('input[name="leaveBenefits"]:checked')?.value === 'OUI';
    
    if (!isNaN(initialLeaveValue)) {
        const showOne = (initialLeaveValue === 1) && initialBenefitsEnabled;
        const showTwo = (initialLeaveValue === 2) && initialBenefitsEnabled;
        
        setRequiredForSection('oneLeaveBenefitSection', showOne);
        setRequiredForSection('twoLeaveBenefitsSection', showTwo);
    }
}

// ==================== LOGIQUES CONDITIONNELLES MODIFIÉES ====================
function setupAllConditionalLogic() {
    // 1. Couple 17-18 : Si rupture par employeur (17) → Afficher question 18
    document.getElementById('terminationParty').addEventListener('change', function() {
        const show = this.value === 'Décision de l\'employeur';
        document.getElementById('employerTerminationSection').classList.toggle('hidden', !show);
        setRequiredForSection('employerTerminationSection', show);
        if (!show) clearSectionData('employerTerminationSection'); // EFFACER LES DONNÉES
    });

    // 2. Couple 18-19 : Si décision écrite (18=OUI) → Afficher question 19
    document.querySelectorAll('input[name="writtenDecision"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('writtenDecisionYesSection').classList.toggle('hidden', !show);
            setRequiredForSection('writtenDecisionYesSection', show);
            if (!show) clearSectionData('writtenDecisionYesSection'); // EFFACER LES DONNÉES
        });
    });

    // 3. Couple 20-21 : Si motif économique (20) → Afficher question 21
    document.getElementById('terminationReason').addEventListener('change', function() {
        const show = this.value === 'raison économique ou nécessité de fonctionnement';
        document.getElementById('economicReasonSection').classList.toggle('hidden', !show);
        setRequiredForSection('economicReasonSection', show);
        if (!show) clearSectionData('economicReasonSection'); // EFFACER LES DONNÉES
    });

    // 4. Couple 20-22 : Si faute lourde (20) → Afficher question 22
    document.getElementById('terminationReason').addEventListener('change', function() {
        const show = this.value === 'faute lourde du travailleur';
        document.getElementById('seriousFaultSection').classList.toggle('hidden', !show);
        setRequiredForSection('seriousFaultSection', show);
        if (!show) clearSectionData('seriousFaultSection'); // EFFACER LES DONNÉES
    });

    // 5. Couple 17-24 : Si rupture par travailleur (17) → Afficher question 24
    document.getElementById('terminationParty').addEventListener('change', function() {
        const show = this.value === 'Décision du travailleur';
        document.getElementById('workerTerminationSection').classList.toggle('hidden', !show);
        setRequiredForSection('workerTerminationSection', show);
        if (!show) clearSectionData('workerTerminationSection'); // EFFACER LES DONNÉES
    });

    // 6. Couple 24-25 : Si motif = faute employeur (24) → Afficher question 25
    document.getElementById('resignationReason').addEventListener('change', function() {
        const show = this.value === 'le travailleur déclare avoir démissionné à cause de faute de l\'employeur';
        document.getElementById('employerFaultSection').classList.toggle('hidden', !show);
        setRequiredForSection('employerFaultSection', show);
        if (!show) clearSectionData('employerFaultSection'); // EFFACER LES DONNÉES
    });

    // 7. serie 26, 26bis -27 : Si catégorie inconnue (25) → Afficher question 27
    document.getElementById('workerCategory').addEventListener('change', function() {
        const isUnknownCategory = this.value === 'je ne sais pas sa catégorie';
        
        // Afficher 26bis seulement si une catégorie est sélectionnée ET ce n'est pas "je ne sais pas"
        document.getElementById('monthsInCategorySection').classList.toggle('hidden', 
            isUnknownCategory || this.value === '');
        setRequiredForSection('monthsInCategorySection', !isUnknownCategory && this.value !== '');
        if (isUnknownCategory || this.value === '') clearSectionData('monthsInCategorySection'); // EFFACER LES DONNÉES
        
        // Afficher 27 seulement si "je ne sais pas" est sélectionné
        document.getElementById('unknownCategorySection').classList.toggle('hidden', 
            !isUnknownCategory);
        setRequiredForSection('unknownCategorySection', isUnknownCategory);
        if (!isUnknownCategory) clearSectionData('unknownCategorySection'); // EFFACER LES DONNÉES
    });

    // 8. Couple 30-31 : Si heures supp non payées (30=OUI) → Afficher question 31
    document.querySelectorAll('input[name="unpaidOvertime"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('overtimeSection').classList.toggle('hidden', !show);
            setRequiredForSection('overtimeSection', show);
            if (!show) clearSectionData('overtimeSection'); // EFFACER LES DONNÉES
        });
    });

    // 9. Couple 36-37 : Si transport non totalement fourni (36≠oui totalement) → Afficher question 37
    document.getElementById('transportProvision').addEventListener('change', function() {
        const show = this.value !== 'oui totalement';
        document.getElementById('transportCostSection').classList.toggle('hidden', !show);
        setRequiredForSection('transportCostSection', show);
        if (!show) clearSectionData('transportCostSection'); // EFFACER LES DONNÉES
    });

    // 10. Couple 38-39 : Si logement non fourni (38=NON) → Afficher question 39
    document.querySelectorAll('input[name="housingProvided"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'NON';
            document.getElementById('housingCostSection').classList.toggle('hidden', !show);
            setRequiredForSection('housingCostSection', show);
            if (!show) clearSectionData('housingCostSection'); // EFFACER LES DONNÉES
        });
    });

    // 11. Couple 40-41 : Si allocations familiales payées (40=OUI) → Afficher question 41
    document.querySelectorAll('input[name="familyAllowancePaid"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('familyAllowanceSection').classList.toggle('hidden', !show);
            setRequiredForSection('familyAllowanceSection', show);
            if (!show) clearSectionData('familyAllowanceSection'); // EFFACER LES DONNÉES
        });
    });

    // 12. Couple 43-44 : Si factures médicales impayées (43=OUI) → Afficher question 44
    document.querySelectorAll('input[name="unpaidMedicalBills"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('medicalBillsSection').classList.toggle('hidden', !show);
            setRequiredForSection('medicalBillsSection', show);
            if (!show) clearSectionData('medicalBillsSection'); // EFFACER LES DONNÉES
        });
    });

    // 13. Couple 45-46 : Si voyages service non remboursés (45=OUI) → Afficher question 46
    document.querySelectorAll('input[name="businessTrips"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('businessTripsSection').classList.toggle('hidden', !show);
            setRequiredForSection('businessTripsSection', show);
            if (!show) clearSectionData('businessTripsSection'); // EFFACER LES DONNÉES
        });
    });

    // 14. Couple 48-49 : Si congé prévu (48=OUI) → Afficher question 49
    document.querySelectorAll('input[name="annualLeaveDefined"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('annualLeaveDaysSection').classList.toggle('hidden', !show);
            setRequiredForSection('annualLeaveDaysSection', show);
            if (!show) clearSectionData('annualLeaveDaysSection'); // EFFACER LES DONNÉES
        });
    });

    // 15. Couple 50-51 : Si avantages congé (50=OUI) → Afficher question 51
    document.querySelectorAll('input[name="leaveBenefits"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('leaveBenefitsSection').classList.toggle('hidden', !show);
            setRequiredForSection('leaveBenefitsSection', show);
            if (!show) clearSectionData('leaveBenefitsSection'); // EFFACER LES DONNÉES
        });
    });

    // 18. Couple 54-55 : Si préavis effectué (54=OUI) → Afficher question 55
    document.querySelectorAll('input[name="noticePeriodServed"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('noticePeriodServedSection').classList.toggle('hidden', !show);
            document.getElementById('noticePeriodNotServedSection').classList.toggle('hidden', show);
            
            setRequiredForSection('noticePeriodServedSection', show);
            setRequiredForSection('noticePeriodNotServedSection', !show);
            
            // EFFACER LES DONNÉES des sections cachées
            if (!show) clearSectionData('noticePeriodServedSection');
            if (show) clearSectionData('noticePeriodNotServedSection');
        });
    });

    // 19. Couple 57-58 : Si indemnité préavis (57=OUI) → Afficher question 58
    document.querySelectorAll('input[name="noticeCompensation"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('noticeCompensationSection').classList.toggle('hidden', !show);
            setRequiredForSection('noticeCompensationSection', show);
            if (!show) clearSectionData('noticeCompensationSection'); // EFFACER LES DONNÉES
        });
    });

    // 23. Couple 64-65 : Si immatriculé CNSS (64=OUI) → Afficher question 65
    // 24. Couple 64-66 : Si immatriculé CNSS (64=OUI) → Afficher question 66
    document.querySelectorAll('input[name="socialSecurityRegistered"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const show = this.value === 'OUI';
            document.getElementById('socialSecuritySection').classList.toggle('hidden', !show);
            setRequiredForSection('socialSecuritySection', show);
            if (!show) clearSectionData('socialSecuritySection'); // EFFACER LES DONNÉES
        });
    });
}

// Fonction d'initialisation des conditions
function initializeAllConditions() {
    // Liste des éléments à déclencher
    const triggers = [
        {id: 'terminationParty'},
        {name: 'writtenDecision'},
        {id: 'terminationReason'},
        {id: 'resignationReason'},
        {id: 'workerCategory'}, // Spécifique pour 26/26bis/27
        {name: 'unpaidOvertime'},
        {id: 'transportProvision'},
        {name: 'housingProvided'},
        {name: 'familyAllowancePaid'},
        {name: 'unpaidMedicalBills'},
        {name: 'businessTrips'},
        {name: 'annualLeaveDefined'},
        {name: 'leaveBenefits'}, // Ajout pour Q50
        {id: 'annualLeaveTaken'}, // Ajout pour Q47
        {name: 'noticePeriodServed'},
        {name: 'noticeCompensation'},
        {name: 'sameLocation'},
        {name: 'returnTripRequested'},
        {name: 'socialSecurityRegistered'}
    ];

    triggers.forEach(trigger => {
        const element = trigger.id 
            ? document.getElementById(trigger.id) 
            : document.querySelector(`input[name="${trigger.name}"]:checked`);
            
        if (element) {
            const event = new Event('change');
            element.dispatchEvent(event);
        }
    });

    // Initialisation spécifique pour la page 8
    const annualLeaveTaken = document.getElementById('annualLeaveTaken');
    const leaveBenefits = document.querySelector('input[name="leaveBenefits"]:checked');
    
    if (annualLeaveTaken && leaveBenefits) {
        // Déclencher manuellement la mise à jour de la visibilité
        setTimeout(() => {
            const event = new Event('change');
            annualLeaveTaken.dispatchEvent(event);
            if (leaveBenefits) {
                leaveBenefits.dispatchEvent(new Event('change'));
            }
        }, 100);
    }

    // Initialisation spécifique pour la catégorie de travailleur
    const workerCategory = document.getElementById('workerCategory');
    if (workerCategory) {
        // Force l'évaluation initiale
        const event = new Event('change');
        workerCategory.dispatchEvent(event);
        
        // Ré-applique la valeur si elle existe
        if (workerCategory.value) {
            setTimeout(() => {
                workerCategory.dispatchEvent(new Event('change'));
            }, 100);
        }
    }
}

// ==================== GÉNÉRATION DU CONTENU DE RÉVISION ====================
function generateReviewContent() {
    console.log("=== DÉBUT GÉNÉRATION RÉVISION ===");
    
    const reviewContent = document.getElementById('reviewContent');
    if (!reviewContent) {
        console.error("ERREUR: Élément reviewContent introuvable!");
        return;
    }
    reviewContent.innerHTML = '<p class="loading-text">Chargement de votre révision...</p>';

    try {
        // 1. Liste de toutes les pages de questions
        const questionPages = Array.from(document.querySelectorAll('.page[id^="page"]'))
            .filter(page => !['page1','page13','page14','page15','page16','pageResult'].includes(page.id));
        
        console.log(`Pages à analyser: ${questionPages.length}`, questionPages);

        // 2. Collecte des réponses
        let hasContent = false;
        const fragment = document.createDocumentFragment();

        questionPages.forEach(page => {
            const inputs = page.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                let questionText = '';
                const label = input.labels?.item(0) || 
                            input.closest('.form-group')?.querySelector('label');
                
                if (label) {
                    questionText = label.textContent
                        .replace(/^\d+\.\s*/, '') // Enlève les numéros
                        .replace(':', '')
                        .trim();
                }

                let answer = '';
                if (input.type === 'radio' || input.type === 'checkbox') {
                    if (input.checked) answer = input.value;
                } else if (input.tagName === 'SELECT') {
                    answer = input.options[input.selectedIndex]?.text;
                } else {
                    answer = input.value;
                }

                if (answer && questionText) {
                    hasContent = true;
                    const item = document.createElement('div');
                    item.className = 'review-item';
                    item.innerHTML = `
                        <div class="review-question">${questionText}</div>
                        <div class="review-answer">${answer}</div>
                        <button class="edit-btn" 
                                data-page="${page.id.replace('page','')}"
                                data-field="${input.id || input.name}">
                            Modifier
                        </button>
                    `;
                    fragment.appendChild(item);
                }
            });
        });

        // 3. Affichage final
        if (hasContent) {
            reviewContent.innerHTML = '';
            reviewContent.appendChild(fragment);
            setupEditHandlers();
            console.log("Révision générée avec succès");
        } else {
            reviewContent.innerHTML = '<p class="no-data">Aucune donnée à afficher</p>';
            console.warn("Aucune réponse trouvée pour la révision");
        }

    } catch (error) {
        console.error("Erreur lors de la génération:", error);
        reviewContent.innerHTML = `
            <p class="error-msg">
                Erreur technique lors du chargement. 
                <button onclick="generateReviewContent()">Réessayer</button>
            </p>
        `;
    }
}

function setupEditHandlers() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // 1. Récupère l'ID du champ associé
            const fieldId = this.dataset.field;
            if (!fieldId) {
                console.error("Data-field manquant sur le bouton Modifier");
                return;
            }
            
            // 2. Trouve la page d'origine
            const targetPage = getOriginalPage(fieldId);
            
            // 3. Navigue vers la page
            navigateToPage(targetPage);
            
            // 4. Focus sur le champ après un léger délai
            setTimeout(() => {
                const fieldElement = document.getElementById(fieldId);
                if (fieldElement) {
                    fieldElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    fieldElement.focus();
                    
                    // Animation visuelle (optionnelle)
                    fieldElement.style.backgroundColor = '#fffde7';
                    setTimeout(() => {
                        fieldElement.style.backgroundColor = '';
                    }, 1500);
                }
            }, 100);
        });
    });
}

function getOriginalPage(fieldId) {
    // Mappage des champs vers leurs pages
    const fieldToPageMap = {
        // Page 2 - Identification employeur
        'employerName': 2,
        'employerLocation': 2,
        
        // Page 3 - Identification travailleur
        'workerName': 3,
        'birthDate': 3,
        'gender': 3,
        'maritalStatus': 3,
        'childrenCount': 3,
        
        // Page 4 - Conclusion/rupture contrat
        'contractType': 4,
        'indefiniteContract': 4,
        'contractStartDate': 4,
        'recruitmentLocation': 4,
        'workDaysPerWeek': 4,
        'contractEndDate': 4,
        'terminationLocation': 4,
        'lastAssignment': 4,
        'sameLocation': 4,
        'terminationParty': 4,
        'writtenDecision': 4,
        'noticePeriodDays': 4, // Q19
        'terminationReason': 4,
        'workInspectorAuthorization': 4,
        'faultKnowledgeDate': 4,
        'terminationMotivationEvaluation': 4,
        'resignationReason': 4,
        'workerComplaintsEvaluation': 4,
        
        // Page 5 - Catégorie travailleur
        'workerCategory': 5,
        'categoryHelp': 5,
        'workRegime': 5,
        'dailyWorkHours': 5,
        'unpaidOvertime': 5,
        'totalOvertimeHours': 5,
        'sundayOvertime': 5,
        'holidayOvertime': 5,
        'firstWeeklyOvertime': 5,
        'remainingOvertime': 5,
        
        // Page 6 - Rémunération
        'salaryCurrency': 6,
        'monthlySalary': 6,
        'monthlyTransport': 6,
        'monthlyHousing': 6,
        'monthlyFamilyAllowance': 6,
        'unpaidAmount': 6,
        'unpaidCurrency': 6,
        
        // Page 7 - Avantages obligatoires
        'commuteDistance': 7,
        'transportProvision': 7,
        'dailyTransportCurrency': 7,
        'dailyTransportCost': 7,
        'housingProvided': 7,
        'housingCurrency': 7,
        'monthlyHousingCost': 7,
        'familyAllowancePaid': 7,
        'familyAllowanceCurrency': 7,
        'actualFamilyAllowance': 7,
        'healthcareProvided': 7,
        'unpaidMedicalBills': 7,
        'medicalBillsCurrency': 7,
        'medicalBillsAmount': 7,
        'businessTrips': 7,
        'businessTripsCurrency': 7,
        'businessTripsAmount': 7,
        
        // Page 8 - Congé annuel
        'annualLeaveTaken': 8,
        'annualLeaveDefined': 8,
        'definedAnnualLeaveDays': 8,
        'leaveBenefits': 8,
        'leaveBenefitAmount': 8,
        'leaveBenefitCurrency': 8,
        'oneLeaveBenefitReceived': 8,
        'twoLeaveBenefitsReceived': 8,
        
        // Page 9 - Préavis
        'noticePeriodServed': 9,
        'noticePeriodDaysPage9': 9, // Q55: Updated ID
        'noticePaymentCurrency': 9,
        'noticePaymentAmount': 9,
        'noticeCompensation': 9,
        'compensationCurrency': 9,
        'compensationAmount': 9,
        
        // Page 10 - Voyage retour (conditionnelle)
        'returnTripRequested': 10,
        'returnTripSupport': 10,
        'returnTripCurrency': 10,
        'returnTripCost': 10,
        'employerPaidCurrency': 10,
        'employerPaidAmount': 10,
        'returnTripWaitingDays': 10,
        
        // Page 11 - CNSS
        'socialSecurityRegistered': 11,
        'registrationYear': 11,
        'registrationMonth': 11,
        'contributionMonths': 11,
        
        // Page 12 - Email
        'clientEmail': 12
    };

    return fieldToPageMap[fieldId] || 1;
}

// ==================== VALIDATION POUR L'ANNÉE D'IMMATRICULATION ====================
function validateRegistrationYear(input) {
    const currentYear = new Date().getFullYear();
    const value = parseInt(input.value);
    
    if (isNaN(value)) {
        input.setCustomValidity("Veuillez entrer une année valide");
        return false;
    }
    
    if (value < 1960) {
        input.setCustomValidity("L'année doit être au moins 1960");
        return false;
    }
    
    if (value > currentYear) {
        input.setCustomValidity(`L'année ne peut pas dépasser ${currentYear}`);
        return false;
    }
    
    input.setCustomValidity("");
    return true;
}

// ==================== FONCTIONS DE PAIEMENT ====================
function checkPaymentStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment_status');
    
    if (paymentStatus === 'success') {
        navigateToPage(15);
        handlePaymentSuccess();
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (paymentStatus === 'failed') {
        const errorMessage = urlParams.get('error_message') || 'Paiement échoué';
        navigateToPage(16);
        handlePaymentFailure(errorMessage);
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

async function processPayment() {
    const btn = document.getElementById('startPaymentBtn');
    if (!btn) throw new Error("Bouton de paiement introuvable");

    try {
        btn.disabled = true;
        btn.textContent = 'Traitement en cours...';

        const clientEmail = document.getElementById('clientEmail').value;
        if (!clientEmail) {
            alert("Veuillez entrer votre adresse email avant de procéder au paiement.");
            btn.disabled = false;
            btn.textContent = 'Effectuer le paiement';
            return;
        }

        saveFormData();

        const paymentData = {
            amount: PAYMENT_AMOUNT,
            shop_name: SHOP_NAME,
            message: PAYMENT_DESCRIPTION,
            success_url: window.location.origin + window.location.pathname + "?payment_status=success",
            failure_url: window.location.origin + window.location.pathname + "?payment_status=failed&error_message=Payment_cancelled",
            order_id: `NSOLOT-${Date.now()}`,
            customer_email: clientEmail,
            customer_name: document.getElementById('workerName').value
        };

        const response = await fetch("https://api.lygosapp.com/v1/gateway", {
            method: 'POST',
            headers: {
                "api-key": LYGS_API_KEY,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(paymentData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        if (!data?.link) throw new Error("Pas de lien de paiement reçu");

        localStorage.setItem('paymentData', JSON.stringify({
            transactionId: paymentData.order_id,
            amount: paymentData.amount,
            status: 'PENDING',
            timestamp: new Date().toISOString()
        }));

        window.location.href = data.link;
    } catch (error) {
        console.error("Erreur de paiement:", error);
        showPaymentStatus(`Erreur: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Effectuer le paiement';
        throw error;
    }
}

function handlePaymentSuccess() {
    document.getElementById('paymentSuccessSection').style.display = 'block';
    document.getElementById('startPaymentBtn').style.display = 'none';
    
    const paymentData = JSON.parse(localStorage.getItem('paymentData') || '{}');
    paymentData.status = 'COMPLETED';
    localStorage.setItem('paymentData', JSON.stringify(paymentData));
    
    document.getElementById('paymentId').value = paymentData.transactionId || 'Référence non disponible';
    
    showPaymentStatus('Paiement réussi! Vous pouvez maintenant soumettre le formulaire.', 'success');
}

function handlePaymentFailure(errorMessage) {
    console.error('Échec du paiement:', errorMessage);
    
    const errorDetails = document.getElementById('paymentErrorDetails');
    if (errorDetails) {
        errorDetails.innerHTML = `
            <p><strong>Détails de l'erreur:</strong> ${errorMessage}</p>
            <p><strong>Heure:</strong> ${new Date().toLocaleString()}</p>
        `;
    }
    
    showPaymentStatus(`Échec du paiement: ${errorMessage}`, 'error');
}

function showPaymentStatus(message, type) {
    const statusElement = document.getElementById('paymentStatus');
    if (!statusElement) return;
    
    statusElement.textContent = message;
    statusElement.classList.remove('hidden', 'payment-success', 'payment-pending');
    
    if (type === 'success') {
        statusElement.classList.add('payment-success');
    } else if (type === 'pending') {
        statusElement.classList.add('payment-pending');
    } else if (type === 'error') {
        statusElement.classList.add('payment-error');
    }
    
    statusElement.classList.remove('hidden');
}
// ==================== AFFICHAGE DU MESSAGE DE CONFIRMATION ====================
function displayConfirmationMessage(response) {
    const resultContent = document.getElementById('resultContent');
    
    if (response && response.success) {
        resultContent.innerHTML = `
            <div class="confirmation-message">
                <div class="success-icon">✅</div>
                <h3>Confirmation</h3>
                <div class="confirmation-text">
                    <p>${response.message || "Vos données ont été envoyées avec succès, ouvrez votre boîte pour consulter les résultats."}</p>
                    ${response.submissionId ? `<p><strong>Référence:</strong> ${response.submissionId}</p>` : ''}
                    <p><strong>Heure de traitement:</strong> ${new Date().toLocaleString()}</p>
                </div>
            </div>
        `;
        
        // Activer le bouton "Nouveau Calcul"
        document.getElementById('newCalculationBtn').disabled = false;
        document.getElementById('newCalculationBtn').style.opacity = "1";
        document.getElementById('newCalculationBtn').style.cursor = "pointer";
    } else {
        resultContent.innerHTML = `
            <div class="error-message">
                <div class="error-icon">❌</div>
                <h3>Erreur</h3>
                <div class="error-text">
                    <p>${response.message || "Une erreur s'est produite lors de l'envoi des données."}</p>
                    <p>Vous pouvez réessayer sans avoir à payer à nouveau.</p>
                </div>
                <div class="error-actions">
                    <button id="retrySubmitBtn" class="retry-btn">Réessayer l'envoi</button>
                    <button onclick="navigateToPage(14)" class="secondary">Retour au formulaire</button>
                </div>
            </div>
        `;
        
        // Ajouter l'écouteur d'événement pour le bouton de réessai
        setTimeout(() => {
            const retryBtn = document.getElementById('retrySubmitBtn');
            if (retryBtn) {
                retryBtn.addEventListener('click', retrySubmission);
            }
        }, 100);
    }
}

// Nouvel essai d'envoi des données
function retrySubmission() {
    // Afficher l'état de chargement
    document.getElementById('resultContent').innerHTML = `
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Nouvelle tentative d'envoi en cours...</p>
            <p>Veuillez patienter pendant le traitement</p>
        </div>
    `;
    
    // Réessayer la soumission après un court délai
    setTimeout(async () => {
        try {
            const rawData = collectFlattenedFormData();
            
            // Envoyer les données au serveur sans attendre de réponse
            sendDataToServer(rawData).then(response => {
                // Attendre 5 secondes avant d'afficher le message
                setTimeout(() => {
                    // Afficher le message de confirmation même si le serveur ne répond pas
                    displayConfirmationMessage({
                        success: true,
                        message: "Vos données ont été envoyées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                        submissionId: rawData.submissionId || "inconnu",
                        timestamp: new Date().toISOString()
                    });
                    
                    // Effacer les données sauvegardées après succès
                    clearSavedFormData();
                }, 5000);
            }).catch(error => {
                console.error("Erreur lors de l'envoi des données:", error);
                // Attendre 5 secondes même en cas d'erreur
                setTimeout(() => {
                    // Afficher quand même un message de succès (mode optimiste)
                    displayConfirmationMessage({
                        success: true,
                        message: "Vos données ont été traitées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                        submissionId: rawData.submissionId || "inconnu",
                        timestamp: new Date().toISOString()
                    });
                    
                    // Effacer les données sauvegardées
                    clearSavedFormData();
                }, 5000);
            });
            
        } catch (error) {
            console.error("Erreur lors de la nouvelle tentative:", error);
            // En cas d'erreur, attendre aussi 5 secondes
            setTimeout(() => {
                displayConfirmationMessage({
                    success: false,
                    message: "Échec de la nouvelle tentative. Veuillez vérifier votre connexion internet."
                });
            }, 5000);
        }
    }, 1000);
}

// ==================== FONCTION PWA POUR L'INSTALLATION ====================
function initializePWA() {
    // Vérifier si le service worker est supporté
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Enregistrer le service worker
            navigator.serviceWorker.register('sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    // Gérer l'installation de l'application
    const installButton = document.getElementById('installButton');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // Empêcher le mini-infobar d'apparaître sur mobile
        e.preventDefault();
        // Stocker l'événement pour qu'il puisse être déclenché plus tard
        deferredPrompt = e;
        // Afficher le bouton d'installation
        installButton.style.display = 'block';
        
        installButton.addEventListener('click', async () => {
            // Masquer le bouton d'installation
            installButton.style.display = 'none';
            // Afficher l'invite d'installation
            deferredPrompt.prompt();
            // Attendre que l'utilisateur réponde à l'invite
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            // On n'a plus besoin de l'invite
            deferredPrompt = null;
        });
    });

    window.addEventListener('appinstalled', () => {
        // Masquer le bouton d'installation
        installButton.style.display = 'none';
        // Effacer l'invite sauvegardée
        deferredPrompt = null;
        console.log('PWA was installed');
    });
}

// ==================== INITIALISATION ====================
function initializeApplication() {
    restoreFormData();
    setupAllConditionalLogic();
    setupPage8SpecificLogic();
    initializeAllConditions();
    setupAutoSave();
    initializePWA(); // Initialiser les fonctionnalités PWA
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('birthDate').max = today;
    document.getElementById('contractStartDate').max = today;
    document.getElementById('contractEndDate').max = today;
    document.getElementById('faultKnowledgeDate').max = today;
    
    // Configuration améliorée pour le champ registrationYear
    const registrationYearInput = document.getElementById('registrationYear');
    if (registrationYearInput) {
        const currentYear = new Date().getFullYear();
        
        // Définir l'année maximum mais permettre la saisie manuelle
        registrationYearInput.max = currentYear;
        
        // Ajouter la validation oninput
        registrationYearInput.addEventListener('input', function() {
            validateRegistrationYear(this);
        });
        
        // Ajouter la validation onblur (quand le champ perd le focus)
        registrationYearInput.addEventListener('blur', function() {
            if (this.value && !validateRegistrationYear(this)) {
                this.focus();
            }
        });
    }
    
    // Ajouter la validation pour les heures de travail quotidiennes
    const dailyHoursInput = document.getElementById('dailyWorkHours');
    if (dailyHoursInput) {
        dailyHoursInput.addEventListener('input', function() {
            validateDailyHours(this);
        });
    }
    
    // Initialiser la barre de progression
    updateProgressBar();
}

// ==================== CONFIGURATION DES ÉCOUTEURS D'ÉVÉNEMENTS ====================
function setupNavigationListeners() {
    document.getElementById('startBtn').addEventListener('click', nextPage);
    document.getElementById('backToPage1').addEventListener('click', prevPage);
    document.getElementById('nextToPage3').addEventListener('click', nextPage);
    document.getElementById('backToPage2').addEventListener('click', prevPage);
    document.getElementById('nextToPage4').addEventListener('click', nextPage);
    document.getElementById('backToPage3').addEventListener('click', prevPage);
    document.getElementById('nextToPage5').addEventListener('click', nextPage);
    document.getElementById('backToPage4').addEventListener('click', prevPage);
    document.getElementById('nextToPage6').addEventListener('click', nextPage);
    document.getElementById('backToPage5').addEventListener('click', prevPage);
    document.getElementById('nextToPage7').addEventListener('click', nextPage);
    document.getElementById('backToPage6').addEventListener('click', prevPage);
    document.getElementById('nextToPage8').addEventListener('click', nextPage);
    document.getElementById('backToPage7').addEventListener('click', prevPage);
    document.getElementById('nextToPage9').addEventListener('click', nextPage);
    document.getElementById('backToPage8').addEventListener('click', prevPage);
    document.getElementById('nextToPage10').addEventListener('click', nextPage);
    document.getElementById('backToPage9').addEventListener('click', prevPage);
    document.getElementById('nextToPage11').addEventListener('click', nextPage);
    document.getElementById('backToPage10').addEventListener('click', prevPage);
    document.getElementById('nextToPage12').addEventListener('click', nextPage);
    document.getElementById('backToPage11').addEventListener('click', prevPage);
    document.getElementById('nextToPage14').addEventListener('click', nextPage);
    
    document.getElementById('backToPage12').addEventListener('click', function() {
        initializeAllConditions();
        document.getElementById('page14').classList.remove('active');
        document.getElementById('page12').classList.add('active');
        currentPage = 12;
        updateProgressBar();
        setTimeout(initializeAllConditions, 50);
    });
    
    document.getElementById('nextToPage15').addEventListener('click', function() {
        document.getElementById('page14').classList.remove('active');
        document.getElementById('page15').classList.add('active');
        currentPage = 15;
        updateProgressBar();
    });
    
    document.getElementById('backToPage14').addEventListener('click', function() {
        document.getElementById('page15').classList.remove('active');
        document.getElementById('page14').classList.add('active');
        currentPage = 14;
        updateProgressBar();
    });
}

// ==================== ÉCOUTEURS D'ÉVÉNEMENTS PRINCIPAUX ====================
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser l'application
    initializeApplication();
    
    // Vérifier le statut de paiement
    checkPaymentStatus();
    
    // Configurer les écouteurs de navigation
    setupNavigationListeners();
    
    // Configurer UN SEUL écouteur pour le bouton de soumission
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        // Supprimer tous les écouteurs existants
        submitBtn.replaceWith(submitBtn.cloneNode(true));
        
        // Ajouter un seul écouteur
        document.getElementById('submitBtn').addEventListener('click', function(event) {
            submitForm(event);
        });
    }
    
    // Configurer les autres écouteurs de boutons
    const startPaymentBtn = document.getElementById('startPaymentBtn');
    if (startPaymentBtn) {
        startPaymentBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            try {
                await processPayment();
            } catch (error) {
                console.error("Erreur lors du processus de paiement:", error);
                handlePaymentFailure(error.message);
            }
        });
    }

    const retryPaymentBtn = document.getElementById('retryPaymentBtn');
    if (retryPaymentBtn) {
        retryPaymentBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            try {
                await processPayment();
            } catch (error) {
                console.error("Erreur lors du réessai de paiement:", error);
                handlePaymentFailure(error.message);
            }
        });
    }

    const backToFormBtn = document.getElementById('backToFormBtn');
    if (backToFormBtn) {
        backToFormBtn.addEventListener('click', (event) => {
            event.preventDefault();
            navigateToPage(14);
        });
    }

    // Configurer le bouton "Nouveau calcul"
    document.getElementById('newCalculationBtn').addEventListener('click', () => {
        clearSavedFormData();
        currentPage = 1;
        navigateToPage(1);
        
        // Réinitialiser le bouton pour la prochaine utilisation
        document.getElementById('newCalculationBtn').disabled = true;
    });
});
</script>
</body>
</html>


