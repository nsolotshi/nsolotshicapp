// ==================== AFFICHAGE DU MESSAGE DE CONFIRMATION ====================
function displayConfirmationMessage(response) {
    const resultContent = document.getElementById('resultContent');
    
    if (response && response.success) {
        resultContent.innerHTML = `
            <div class="confirmation-message">
                <div class="success-icon">✅</div>
                <h3>Confirmation</h3>
                <div class="confirmation-text">
                    <p>${response.message || "Vos données ont été envoyées avec succès, ouvrez votre boîte pour consulter les résultats."}</p>
                    ${response.submissionId ? `<p><strong>Référence:</strong> ${response.submissionId}</p>` : ''}
                    <p><strong>Heure de traitement:</strong> ${new Date().toLocaleString()}</p>
                </div>
            </div>
        `;
        
        // Activer le bouton "Nouveau Calcul"
        document.getElementById('newCalculationBtn').disabled = false;
        document.getElementById('newCalculationBtn').style.opacity = "1";
        document.getElementById('newCalculationBtn').style.cursor = "pointer";
    } else {
        resultContent.innerHTML = `
            <div class="error-message">
                <div class="error-icon">❌</div>
                <h3>Erreur</h3>
                <div class="error-text">
                    <p>${response.message || "Une erreur s'est produite lors de l'envoi des données."}</p>
                    <p>Vous pouvez réessayer sans avoir à payer à nouveau.</p>
                </div>
                <div class="error-actions">
                    <button id="retrySubmitBtn" class="retry-btn">Réessayer l'envoi</button>
                    <button onclick="navigateToPage(14)" class="secondary">Retour au formulaire</button>
                </div>
            </div>
        `;
        
        // Ajouter l'écouteur d'événement pour le bouton de réessai
        setTimeout(() => {
            const retryBtn = document.getElementById('retrySubmitBtn');
            if (retryBtn) {
                retryBtn.addEventListener('click', retrySubmission);
            }
        }, 100);
    }
}

// Nouvel essai d'envoi des données
function retrySubmission() {
    // Afficher l'état de chargement
    document.getElementById('resultContent').innerHTML = `
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Nouvelle tentative d'envoi en cours...</p>
            <p>Veuillez patienter pendant le traitement</p>
        </div>
    `;
    
    // Réessayer la soumission après un court délai
    setTimeout(async () => {
        try {
            const rawData = collectFlattenedFormData();
            
            // Envoyer les données au serveur sans attendre de réponse
            sendDataToServer(rawData).then(response => {
                // Attendre 5 secondes avant d'afficher le message
                setTimeout(() => {
                    // Afficher le message de confirmation même si le serveur ne répond pas
                    displayConfirmationMessage({
                        success: true,
                        message: "Vos données ont été envoyées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                        submissionId: rawData.submissionId || "inconnu",
                        timestamp: new Date().toISOString()
                    });
                    
                    // Effacer les données sauvegardées après succès
                    clearSavedFormData();
                }, 5000);
            }).catch(error => {
                console.error("Erreur lors de l'envoi des données:", error);
                // Attendre 5 secondes même en cas d'erreur
                setTimeout(() => {
                    // Afficher quand même un message de succès (mode optimiste)
                    displayConfirmationMessage({
                        success: true,
                        message: "Vos données ont été traitées avec succès. La fiche détaillée en PDF vient de vous être envoyée par email. Nous vous remercions d'avoir fait confiance à nos services",
                        submissionId: rawData.submissionId || "inconnu",
                        timestamp: new Date().toISOString()
                    });
                    
                    // Effacer les données sauvegardées
                    clearSavedFormData();
                }, 5000);
            });
            
        } catch (error) {
            console.error("Erreur lors de la nouvelle tentative:", error);
            // En cas d'erreur, attendre aussi 5 secondes
            setTimeout(() => {
                displayConfirmationMessage({
                    success: false,
                    message: "Échec de la nouvelle tentative. Veuillez vérifier votre connexion internet."
                });
            }, 5000);
        }
    }, 1000);
}

// ==================== FONCTION PWA POUR L'INSTALLATION ====================
function initializePWA() {
    // Vérifier si le service worker est supporté
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Enregistrer le service worker
            navigator.serviceWorker.register('sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    // Gérer l'installation de l'application
    const installButton = document.getElementById('installButton');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // Empêcher le mini-infobar d'apparaître sur mobile
        e.preventDefault();
        // Stocker l'événement pour qu'il puisse être déclenché plus tard
        deferredPrompt = e;
        // Afficher le bouton d'installation
        installButton.style.display = 'block';
        
        installButton.addEventListener('click', async () => {
            // Masquer le bouton d'installation
            installButton.style.display = 'none';
            // Afficher l'invite d'installation
            deferredPrompt.prompt();
            // Attendre que l'utilisateur réponde à l'invite
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            // On n'a plus besoin de l'invite
            deferredPrompt = null;
        });
    });

    window.addEventListener('appinstalled', () => {
        // Masquer le bouton d'installation
        installButton.style.display = 'none';
        // Effacer l'invite sauvegardée
        deferredPrompt = null;
        console.log('PWA was installed');
    });
}

// ==================== INITIALISATION ====================
function initializeApplication() {
    restoreFormData();
    setupAllConditionalLogic();
    setupPage8SpecificLogic();
    initializeAllConditions();
    setupAutoSave();
    initializePWA(); // Initialiser les fonctionnalités PWA
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('birthDate').max = today;
    document.getElementById('contractStartDate').max = today;
    document.getElementById('contractEndDate').max = today;
    document.getElementById('faultKnowledgeDate').max = today;
    
    // Configuration améliorée pour le champ registrationYear
    const registrationYearInput = document.getElementById('registrationYear');
    if (registrationYearInput) {
        const currentYear = new Date().getFullYear();
        
        // Définir l'année maximum mais permettre la saisie manuelle
        registrationYearInput.max = currentYear;
        
        // Ajouter la validation oninput
        registrationYearInput.addEventListener('input', function() {
            validateRegistrationYear(this);
        });
        
        // Ajouter la validation onblur (quand le champ perd le focus)
        registrationYearInput.addEventListener('blur', function() {
            if (this.value && !validateRegistrationYear(this)) {
                this.focus();
            }
        });
    }
    
    // Ajouter la validation pour les heures de travail quotidiennes
    const dailyHoursInput = document.getElementById('dailyWorkHours');
    if (dailyHoursInput) {
        dailyHoursInput.addEventListener('input', function() {
            validateDailyHours(this);
        });
    }
    
    // Initialiser la barre de progression
    updateProgressBar();
}

// ==================== CONFIGURATION DES ÉCOUTEURS D'ÉVÉNEMENTS ====================
function setupNavigationListeners() {
    document.getElementById('startBtn').addEventListener('click', nextPage);
    document.getElementById('backToPage1').addEventListener('click', prevPage);
    document.getElementById('nextToPage3').addEventListener('click', nextPage);
    document.getElementById('backToPage2').addEventListener('click', prevPage);
    document.getElementById('nextToPage4').addEventListener('click', nextPage);
    document.getElementById('backToPage3').addEventListener('click', prevPage);
    document.getElementById('nextToPage5').addEventListener('click', nextPage);
    document.getElementById('backToPage4').addEventListener('click', prevPage);
    document.getElementById('nextToPage6').addEventListener('click', nextPage);
    document.getElementById('backToPage5').addEventListener('click', prevPage);
    document.getElementById('nextToPage7').addEventListener('click', nextPage);
    document.getElementById('backToPage6').addEventListener('click', prevPage);
    document.getElementById('nextToPage8').addEventListener('click', nextPage);
    document.getElementById('backToPage7').addEventListener('click', prevPage);
    document.getElementById('nextToPage9').addEventListener('click', nextPage);
    document.getElementById('backToPage8').addEventListener('click', prevPage);
    document.getElementById('nextToPage10').addEventListener('click', nextPage);
    document.getElementById('backToPage9').addEventListener('click', prevPage);
    document.getElementById('nextToPage11').addEventListener('click', nextPage);
    document.getElementById('backToPage10').addEventListener('click', prevPage);
    document.getElementById('nextToPage12').addEventListener('click', nextPage);
    document.getElementById('backToPage11').addEventListener('click', prevPage);
    document.getElementById('nextToPage14').addEventListener('click', nextPage);
    
    document.getElementById('backToPage12').addEventListener('click', function() {
        initializeAllConditions();
        document.getElementById('page14').classList.remove('active');
        document.getElementById('page12').classList.add('active');
        currentPage = 12;
        updateProgressBar();
        setTimeout(initializeAllConditions, 50);
    });
    
    document.getElementById('nextToPage15').addEventListener('click', function() {
        document.getElementById('page14').classList.remove('active');
        document.getElementById('page15').classList.add('active');
        currentPage = 15;
        updateProgressBar();
    });
    
    document.getElementById('backToPage14').addEventListener('click', function() {
        document.getElementById('page15').classList.remove('active');
        document.getElementById('page14').classList.add('active');
        currentPage = 14;
        updateProgressBar();
    });
}

// ==================== ÉCOUTEURS D'ÉVÉNEMENTS PRINCIPAUX ====================
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser l'application
    initializeApplication();
    
    // Vérifier le statut de paiement
    checkPaymentStatus();
    
    // Configurer les écouteurs de navigation
    setupNavigationListeners();
    
    // Configurer UN SEUL écouteur pour le bouton de soumission
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        // Supprimer tous les écouteurs existants
        submitBtn.replaceWith(submitBtn.cloneNode(true));
        
        // Ajouter un seul écouteur
        document.getElementById('submitBtn').addEventListener('click', function(event) {
            submitForm(event);
        });
    }
    
    // Configurer les autres écouteurs de boutons
    const startPaymentBtn = document.getElementById('startPaymentBtn');
    if (startPaymentBtn) {
        startPaymentBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            try {
                await processPayment();
            } catch (error) {
                console.error("Erreur lors du processus de paiement:", error);
                handlePaymentFailure(error.message);
            }
        });
    }

    const retryPaymentBtn = document.getElementById('retryPaymentBtn');
    if (retryPaymentBtn) {
        retryPaymentBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            try {
                await processPayment();
            } catch (error) {
                console.error("Erreur lors du réessai de paiement:", error);
                handlePaymentFailure(error.message);
            }
        });
    }

    const backToFormBtn = document.getElementById('backToFormBtn');
    if (backToFormBtn) {
        backToFormBtn.addEventListener('click', (event) => {
            event.preventDefault();
            navigateToPage(14);
        });
    }

    // Configurer le bouton "Nouveau calcul"
    document.getElementById('newCalculationBtn').addEventListener('click', () => {
        clearSavedFormData();
        currentPage = 1;
        navigateToPage(1);
        
        // Réinitialiser le bouton pour la prochaine utilisation
        document.getElementById('newCalculationBtn').disabled = true;
    });
});
</script>
</body>
</html>
